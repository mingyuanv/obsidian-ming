---
title: "{{title}}"
aliases: 
tags: 
description: 
source:
---

# å¤‡æ³¨(å£°æ˜)ï¼š





# ä¸€ã€GCC Cè¯­è¨€æ‰©å±•

## å˜é‡ç±»å‹æ‰©å±•
### 1 ã€128ä½çš„æ•´æ•°
```c
__int128 a;
unsigned __int128 b;
```

> **èŒƒå›´â€‹**â€‹ï¼šæœ‰ç¬¦å·ï¼ˆ-2^127 ~ 2^127-1ï¼‰ï¼Œæ— ç¬¦å·ï¼ˆ0 ~ 2^128-1ï¼‰
> â€‹**â€‹é—®é¢˜â€‹**â€‹ï¼šæ ‡å‡†åº“å‡½æ•°ï¼ˆå¦‚`printf`/`scanf`ï¼‰ä¸æ”¯æŒç›´æ¥æ“ä½œ
> 2^128=3.4028236692093846346337460743177e+38
> â€‹**â€‹è§£å†³æ–¹æ¡ˆâ€‹**â€‹ï¼šæˆ–åˆ†é«˜ä½64ä½è¾“å‡ºï¼š


#### ä¸¾ä¾‹ï¼š
```c
    unsigned __int128 val;
    val=(unsigned __int128)0xFFFFFFFFFFFFFFFFULL<< 64| (unsigned __int128)0xFFFFFFFFFFFFFFFFULL;

    printf("High: %lu\nLow: %lu\n", (uint64_t)(val >> 64), (uint64_t)val);
```
> (base) topeet@ubuntu:~/test/gcc$ ./app
`High: 18446744073709551615`
`Low: 18446744073709551615`



### 2 ã€çº¿ç¨‹ç§æœ‰å˜é‡  ï¼ˆThread-local storage (TLS)ï¼‰
```c
// æ¯ä¸ªçº¿ç¨‹ä¼šæœ‰è‡ªå·±ç‹¬ç«‹çš„å˜é‡a
__thread static int a=9;ï¼ˆGCCæ‰©å±•ï¼‰

// C++11åŠä¹‹å
thread_local int var;ï¼ˆæ ‡å‡†å…³é”®å­—ï¼‰
```

> - æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹å­˜å‚¨å˜é‡å‰¯æœ¬ï¼Œç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹ç»‘å®šã€‚
> - é¿å…å…±äº«æ•°æ®çš„ç«äº‰ï¼Œâ€‹**â€‹æ— éœ€é”â€‹**â€‹ï¼ˆå¦‚çº¿ç¨‹å±€éƒ¨æ—¥å¿—ã€ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼‰


### 3 ã€é›¶é•¿åº¦æ•°ç»„
```c
char data[0];ï¼ˆGNUæ‰©å±•ï¼ŒéCæ ‡å‡†ï¼‰
```
- 2 **æ ¸å¿ƒç”¨é€”â€‹**â€‹ï¼šä½œä¸ºç»“æ„ä½“æœ«å°¾çš„â€‹**â€‹çµæ´»æ•°ç»„æˆå‘˜â€‹**â€‹ï¼ˆFlexible Array Memberï¼‰

#### ä¸¾ä¾‹ï¼š
```c
    typedef struct line{
        int length;
        char content[0];
    }line;

    line *l = (line *)malloc(sizeof(line) + 100);

    l->content[99]='a';

    printf("%c\n",l->content[99]);
```
> (base) topeet@ubuntu:~/test/gcc$ ./app
>` a`


### 4 ã€å¯å˜å‚æ•°å®ï¼ˆVariadic Macrosï¼‰
| å®å®šä¹‰å½¢å¼                        | ç©ºå‚æ•°æ”¯æŒ | æ ‡å‡†æ€§       |
| ---------------------------- | ----- | --------- |
| `debug1(fmt, ...)`           | âŒ     | C99       |
| `debug2(fmt, args...)`       | âŒ     | GNUæ‰©å±•     |
| `debug3(fmt, ##__VA_ARGS__)` | âœ…     | GNUæ‰©å±•ï¼ˆæ¨èï¼‰ |
> **â€‹##è¿ç®—ç¬¦çš„ä½œç”¨â€‹**:å½“`__VA_ARGS__`ä¸ºç©ºæ—¶ï¼Œåˆ é™¤å‰é¢çš„é€—å·ï¼Œé¿å…è¯­æ³•é”™è¯¯ï¼š

#### å®é™…åº”ç”¨â€‹
- 1 â€‹â€‹æ—¥å¿—ç³»ç»Ÿâ€‹ï¼š
```c
#define LOG(fmt, ...) printf("[%s]"fmt, __func__, ##__VA_ARGS__)

LOG("error:%d\n",-1);
```
> (base) topeet@ubuntu:~/test/gcc$ ./app
`[main]error:-1`

- 1 è°ƒè¯•å¢å¼ºâ€‹â€‹ï¼šè‡ªåŠ¨æ³¨å…¥æ–‡ä»¶åå’Œè¡Œå·ï¼š
```c
#define DEBUG(fmt, ...) printf("%s:%d " fmt, __FILE__, __LINE__, ##__VA_ARGS__)

DEBUG("error:%d\n",-1);
```
> (base) topeet@ubuntu:~/test/gcc$ ./app
`main.c:19 error:-1`


### 5ã€ ç»“æ„ä½“ä¸æ•°ç»„çš„æŒ‡å®šåˆå§‹åŒ–
```c
    int a[6] = {[2]=1,[3 ... 5]=2,[0]=3};

    for(int i=0;i<6;i++){
        printf("%d ",a[i]);
    }
    printf("\n");

    typedef struct {
        int a;
        int b;
        int c;
    } point;

    point p={.a=11,.b=22,.c=33};

    printf("p.a=%d p.b=%d p.c=%d\n",p.a,p.b,p.c);
```
> (base) topeet@ubuntu:~/test/gcc$ ./app
`3 0 1 2 2 2 `
`p.a=11 p.b=22 p.c=33`




### 6ã€èŒƒå›´case
- 1 **GNUæ‰©å±•â€‹**â€‹ï¼š`case 'A' ... 'Z':`æˆ–Â `case 1 ... 5:`
```c
    int a;
    a=6;
    switch(a){

        case 0 ... 9:
            printf("0-9\n");
            break;

        case 11 ... 19:
            printf("11-19\n");
            break;

        default:
            printf("other\n");
            break;

        break;

    }
```
> (base) topeet@ubuntu:~/test/gcc$ ./app
`0-9`



### 7ã€


### 8ã€



## å£°æ˜å‡½æ•°å±æ€§ï¼ˆÂ `__attribute__((xxx))`ï¼‰
### 1 ã€å‡½æ•°æ‰§è¡Œæ—¶æœºæ§åˆ¶â€‹ï¼ˆ`constructor`/Â `destructor`â€‹ï¼‰
> **`constructor`/Â `destructor`â€‹**
> â€‹
> - â€‹**â€‹åŠŸèƒ½â€‹**â€‹ï¼š`constructor`æŒ‡å®šå‡½æ•°åœ¨Â `main()`å‰è‡ªåŠ¨æ‰§è¡Œï¼Œ`destructor`åœ¨Â `main()`ç»“æŸæˆ–Â `exit()`åæ‰§è¡Œ
> - â€‹**â€‹ä¼˜å…ˆçº§â€‹**â€‹ï¼š
>     - `constructor(priority)`ï¼šæ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼ˆå¦‚Â `__attribute__((constructor(101)))`ï¼‰
>     - `destructor(priority)`ï¼šæ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šä½
>     
> - â€‹**â€‹æ³¨æ„â€‹**â€‹ï¼šC++ é™æ€å¯¹è±¡çš„æ„é€ /ææ„é¡ºåºä¸Â `constructor`/`destructor`çš„é¡ºåºæ— å…³ï¼Œç”±ç¼–è¯‘å™¨å†³å®š
> - â€‹**â€‹åº”ç”¨åœºæ™¯â€‹**â€‹ï¼šå…¨å±€èµ„æºåˆå§‹åŒ–ï¼ˆå¦‚æ—¥å¿—ç³»ç»Ÿï¼‰ã€åº“åŠ è½½æ—¶çš„è‡ªåŠ¨é…ç½®
```c
void __f() { 
    printf("ming\n");
    exit(0);

}

void __f() __attribute((constructor(101)));
```
> (base) topeet@ubuntu:~/test/gcc$ ./app
`ming`


- 2 æ³¨æ„ï¼šæ„é€ å‡½æ•°ä¼˜å…ˆçº§ä»0åˆ°100æ˜¯ä¿ç•™ä½ï¼Œä¸èƒ½ä½¿ç”¨ã€‚

### 2 ã€ç¬¦å·åˆ«åä¸å¯è§æ€§â€‹ï¼ˆaliasã€visibilityï¼‰
#### â€‹â€‹`alias("target")`
- 1 å°†å½“å‰å‡½æ•°å£°æ˜ä¸ºå¦ä¸€ä¸ªå‡½æ•°çš„åˆ«åï¼ˆç­‰ä»·è°ƒç”¨ï¼‰
```c
//åŸå§‹å‡½æ•°
void __f() { printf("ming\n");}

//ç»™ __f èµ·ä¸€ä¸ªåˆ«å __e
void __e() __attribute((weak,alias("__f"),visibility("hidden")));

//å®é™…è°ƒç”¨çš„æ˜¯ __f
    __e();
```
> (base) topeet@ubuntu:~/test/gcc$ ./app
`ming`



#### `visibility("visibility_type")`

| ç±»å‹          | å¯è§æ€§è§„åˆ™            | ç”¨é€”          |
| ----------- | ---------------- | ----------- |
| `default`   | å¤–éƒ¨æ¨¡å—å¯è§ï¼ˆé»˜è®¤ï¼‰       | åŠ¨æ€åº“çš„å…¬å¼€æ¥å£    |
| `hidden`    | **ä»…å½“å‰æ¨¡å—å¯è§**      | å†…éƒ¨å‡½æ•°ï¼Œé¿å…ç¬¦å·å†²çª |
| `internal`  | æ¨¡å—å†…å¯è§ä¸”ä¸å¯è¢«è¦†ç›–      | å…³é”®å†…éƒ¨å‡½æ•°      |
| `protected` | æ¨¡å—å†…å¯è§ï¼Œä½†å¤–éƒ¨å¯å¼•ç”¨ä¸å¯è¦†ç›– | å—é™å…¬å¼€æ¥å£      |

```c
void __e() __attribute((weak,alias("__f"),visibility("hidden")));
```
- 2 **â€‹åº”ç”¨â€‹**â€‹ï¼šåŠ¨æ€é“¾æ¥åº“ï¼ˆ.soï¼‰çš„ç¬¦å·å¯¼å‡ºæ§åˆ¶



### 3 ã€ä»£ç ä¼˜åŒ–ä¸è¡Œä¸ºæ§åˆ¶â€‹ï¼ˆâ€‹â€‹`noreturn`ã€â€‹â€‹`deprecated`ã€`aligned` ï¼‰
#### `noreturn`
- 1 å£°æ˜å‡½æ•°ä¸ä¼šè¿”å›ï¼ˆå¦‚é€€å‡ºå‡½æ•°ï¼‰ï¼Œé¿å…ç¼–è¯‘å™¨ç”Ÿæˆæ— æ•ˆè¿”å›ä»£ç 
```c
void __f() { 
    printf("ming\n");
    exit(0);

}

void __f() __attribute((noreturn));
```
- 2 ç¡®å®éœ€è¦ `__f` ä¸è¿”å›ï¼Œéœ€åœ¨å‡½æ•°ä¸­è°ƒç”¨ `exit()`ã€`abort()` æˆ–è¿›å…¥æ­»å¾ªç¯æ‰è¡Œã€‚


#### `deprecated`
- 1 æ ‡è®°å‡½æ•°å·²åºŸå¼ƒï¼Œè°ƒç”¨æ—¶è§¦å‘ç¼–è¯‘è­¦å‘Š
```c
void __f() { 
    printf("ming\n");
    exit(0);

}

void __f() __attribute((deprecate("æ”¹ç”¨ new__f()")));
```
> (base) topeet@ubuntu:~/test/gcc$ gcc main.c -o app
main.c:16:1:` warning:` â€˜deprecateâ€™ attribute directive ignored [-Wattributes]
   16 | void __ f() __ attribute((deprecate("æ”¹ç”¨ new__f()")));
      | ^~~~
- 2  ä»£ç è¿ç§»æ—¶å…¼å®¹æ—§æ¥å£ã€‚


#### `aligned` 
- 1 æŒ‡å®šå‡½æ•°ç¬¬ä¸€æ¡æŒ‡ä»¤çš„å†…å­˜å¯¹é½ï¼ˆå­—èŠ‚æ•°ï¼‰ï¼Œ`alignment`å¿…é¡»æ˜¯ 2 çš„å¹‚
```c
void __f() __attribute((aligned(64)));
```
- 2 ä¼˜åŒ– CPU æŒ‡ä»¤ç¼“å­˜è¡Œè®¿é—®ï¼ˆå¦‚é«˜é¢‘è°ƒç”¨å‡½æ•°ï¼‰

- 1 â€‹**â€‹å¯¹é½é™åˆ¶â€‹**â€‹ï¼š`aligned`çš„å¯¹é½å€¼å—ç¡¬ä»¶å¹³å°æœ€å¤§å¯¹é½é™åˆ¶ï¼ˆå¦‚ ARM å¯èƒ½ä»…æ”¯æŒ 16 å­—èŠ‚å¯¹é½ï¼‰

### 4 ã€å†…å­˜å¸ƒå±€æ§åˆ¶â€‹ï¼ˆ`section`ï¼‰
- 1 å°†å‡½æ•°ä»é»˜è®¤Â `.text`æ®µç§»è‡³è‡ªå®šä¹‰æ®µ        â€‹â€‹`section ("section-name")`
```c
void __f() __attribute((section(".uboot")));
```
- 2 åµŒå…¥å¼å¼€å‘ä¸­å°†å…³é”®å‡½æ•°æ”¾å…¥ç‰¹å®šå†…å­˜åŒºåŸŸï¼ˆå¦‚ Flash å¯åŠ¨ä»£ç ï¼‰
- 2 é¿å…å‡½æ•°è¢«é“¾æ¥å™¨ä¼˜åŒ–ç§»é™¤ã€‚

### 5ã€æ‰©å±•å±æ€§â€‹ï¼ˆâ€‹â€‹`format`ï¼‰
#### `format (printf, arg_idx, first_to_check)`
- 1 å¯¹å˜å‚å‡½æ•°è¿›è¡Œæ ¼å¼å­—ç¬¦ä¸²æ£€æŸ¥ï¼ˆç±»ä¼¼Â `printf`ï¼‰
```c
void log(const char *fmt,...) __attribute((format(printf,1,2)));
```
- 2 é˜²æ­¢æ ¼å¼å­—ç¬¦ä¸²ä¸å‚æ•°ä¸åŒ¹é…å¯¼è‡´çš„è¿è¡Œæ—¶é”™è¯¯ã€‚

|å‚æ•°|å«ä¹‰|
|---|---|
|`printf`|è¡¨ç¤ºè¯¥å‡½æ•°çš„æ ¼å¼è§„åˆ™åº”éµå¾ªÂ `printf`Â çš„æ ¼å¼è§„åˆ™|
|`1`|è¡¨ç¤ºç¬¬Â **1 ä¸ªå‚æ•°**ï¼ˆä» 1 å¼€å§‹è®¡æ•°ï¼‰æ˜¯æ ¼å¼å­—ç¬¦ä¸²ï¼ˆå³Â `fmt`ï¼‰|
|`2`|è¡¨ç¤ºä»ç¬¬Â **2 ä¸ªå‚æ•°**Â å¼€å§‹æ˜¯å¯å˜å‚æ•°ï¼Œéœ€è¦ä¸æ ¼å¼å­—ç¬¦ä¸²åŒ¹é…|



### 6ã€å…¸å‹åº”ç”¨åœºæ™¯æ€»ç»“â€‹
| â€‹**â€‹å±æ€§â€‹**â€‹      | â€‹**â€‹å…¸å‹ç”¨é€”â€‹**â€‹                |
| --------------- | --------------------------- |
| `constructor`   | åˆå§‹åŒ–å…¨å±€èµ„æºï¼ˆæ•°æ®åº“è¿æ¥ã€ç¡¬ä»¶å¯„å­˜å™¨é…ç½®ï¼‰      |
| `alias`+Â `weak` | åº“çš„é»˜è®¤å®ç°ï¼ˆå…è®¸ç”¨æˆ·è¦†ç›–ï¼‰              |
| `visibility`    | åŠ¨æ€åº“çš„æ¥å£éšè—/å…¬å¼€æ§åˆ¶               |
| `section`       | åµŒå…¥å¼ç³»ç»Ÿçš„å¼•å¯¼ä»£ç ã€ä¸­æ–­å‘é‡è¡¨å®šä½          |
| `noreturn`      | ç»ˆæ­¢è¿›ç¨‹çš„å‡½æ•°ï¼ˆ`exit()`ã€`abort()`ï¼‰ |
| `format`        | è‡ªå®šä¹‰æ—¥å¿—å‡½æ•°çš„å®‰å…¨æ€§æ ¡éªŒ               |




### 7ã€


### 8ã€



## å˜é‡å±æ€§ï¼ˆå®šä¹‰åŒæ—¶ä½¿ç”¨æ‰è¡Œï¼‰
### 1 ã€`section("section-name")`
- 1 å°†å˜é‡æ”¾å…¥è‡ªå®šä¹‰å†…å­˜æ®µï¼ˆè€Œéé»˜è®¤.data/.bssï¼‰
```c
char stack[10000] __attribute((section("STACK"))); // æ ˆç©ºé—´åˆ†é…  
int init_data __attribute__((section("INITDATA")));   // åˆå§‹åŒ–æ•°æ®æ®µ
```

>  â€‹**â€‹åµŒå…¥å¼ç³»ç»Ÿâ€‹**â€‹ï¼šç²¾ç¡®æ§åˆ¶ç¡¬ä»¶å¯„å­˜å™¨æ˜ å°„ï¼ˆå¦‚UARTè®¾å¤‡ï¼‰
>  â€‹**â€‹å¼•å¯¼ç¨‹åºâ€‹**â€‹ï¼šåˆ†ç¦»åˆå§‹åŒ–ä»£ç ä¸è¿è¡Œæ—¶æ•°æ®
>  â€‹**â€‹é™·é˜±â€‹**â€‹ï¼š
>     - æœªåˆå§‹åŒ–å˜é‡å¯èƒ½è¢«æ”¾å…¥`COMMON`æ®µï¼Œå¯¼è‡´é“¾æ¥å†²çª â†’ ç”¨`-fno-common`ç¼–è¯‘é€‰é¡¹æˆ–`__attribute__((nocommon))`


### 2 ã€`aligned(alignment)`
- 1 - æŒ‡å®šå˜é‡/ç»“æ„ä½“çš„å†…å­˜å¯¹é½ï¼ˆalignment=2^nï¼‰
```c
    typedef struct {
        int a;
        int b;
        int c;
    } point;
    point p __attribute((aligned(16)))={.a=11,.b=22,.c=33};// 16å­—èŠ‚å¯¹é½  
    printf("p.a=%d p.b=%d p.c=%d\n",p.a,p.b,p.c);


    int a[10] __attribute((aligned(64)))={1,2,3,4,5,6,7,8,9,10};// ç¼“å­˜è¡Œå¯¹é½
    printf("a=%d\n",a[1]);
```
> (base) topeet@ubuntu:~/test/gcc$ ./app
p.a=11 p.b=22 p.c=33
a=2

- 1 **æ€§èƒ½ä¼˜åŒ–â€‹**â€‹ï¼š
> - é¿å…CPUè·¨ç¼“å­˜è¡Œè®¿é—®ï¼ˆå¦‚SIMDæŒ‡ä»¤è¦æ±‚128ä½å¯¹é½ï¼‰
> - å‡å°‘DMAä¼ è¾“çš„è¾¹ç•Œæ£€æŸ¥å¼€é”€


### 3 ã€







### 4 ã€




### 5ã€



## å†…æ•›æ±‡ç¼–ï¼ˆasmï¼‰
### 1 ã€`asm` å…³é”®å­—å…è®¸åœ¨Cä»£ç ä¸­å†…åµŒæ±‡ç¼–æŒ‡ä»¤


### 2 ã€åŸºç¡€æ ¼å¼â€‹
```c
asm("int $3"); // è§¦å‘è°ƒè¯•æ–­ç‚¹ï¼ˆDebugBreakï¼‰
```

### 3 ã€æ‰©å±•æ ¼å¼ï¼ˆå¸¦æ“ä½œæ•°ï¼‰â€‹
```c
    int src=1;
    int dts;

    asm(
        "mov %1,%0\n\t" //movæŒ‡ä»¤å¤åˆ¶å€¼
        "add $1,%0\n\t"  //addæŒ‡ä»¤åŠ 1
        : "=r"(dts)  // è¾“å‡ºæ“ä½œæ•°
        : "r"(src)   // è¾“å…¥æ“ä½œæ•°
        : "cc"       // ä¿®æ”¹çš„å¯„å­˜å™¨
        // : "memory"   // å¯é€‰ï¼Œè¡¨ç¤ºå†…å­˜å¯èƒ½è¢«ä¿®æ”¹
    );

    printf("%d\n",dts);
```
> (base) topeet@ubuntu:~/test/gcc$ ./app
`2`

- 1 ä»£ç æ­¥éª¤åˆ†æ
> è¾“å…¥æ“ä½œæ•° `"r"(src)` è¡¨ç¤ºç¼–è¯‘å™¨ä¼šå°† `src` çš„å€¼ï¼ˆå³ `1`ï¼‰åŠ è½½åˆ°æŸä¸ªé€šç”¨å¯„å­˜å™¨ä¸­ï¼ˆè®°ä¸ºå¯„å­˜å™¨`A(%1)`ï¼‰ã€‚
> `mov %1, %0` å°†å¯„å­˜å™¨Aï¼ˆè¾“å…¥æ“ä½œæ•° `%1`ï¼‰çš„å€¼å¤åˆ¶åˆ°å¦ä¸€ä¸ªå¯„å­˜å™¨ï¼ˆè¾“å‡ºæ“ä½œæ•° `%0`ï¼Œè®°ä¸ºå¯„å­˜å™¨Bï¼‰ã€‚æ­¤æ—¶å¯„å­˜å™¨Bçš„å€¼ä¸º `1`ã€‚
> `add $1, %0` å¯¹å¯„å­˜å™¨Bï¼ˆå³ `%0`ï¼‰çš„å€¼åŠ 1ã€‚æ­¤æ—¶å¯„å­˜å™¨Bçš„å€¼å˜ä¸º `2`ã€‚
> è¾“å‡ºæ“ä½œæ•° `"=r"(dts)` å°†å¯„å­˜å™¨Bçš„æœ€ç»ˆå€¼ï¼ˆ`2`ï¼‰å†™å…¥å˜é‡ `dts`ã€‚



### 4 ã€åº”ç”¨åœºæ™¯â€‹
> - â€‹**â€‹ç¡¬ä»¶äº¤äº’â€‹**â€‹ï¼šç›´æ¥è¯»å†™ç«¯å£ï¼ˆå¦‚`outb`æŒ‡ä»¤ï¼‰
> - â€‹**â€‹æ€§èƒ½å…³é”®ä»£ç â€‹**â€‹ï¼šæ‰‹åŠ¨ä¼˜åŒ–å¾ªç¯ï¼ˆå¦‚CRC32è®¡ç®—ï¼‰
> - â€‹**â€‹åŸå­æ“ä½œå®ç°â€‹**â€‹ï¼šé€šè¿‡`lock cmpxchg`æŒ‡ä»¤æ„å»ºè‡ªæ—‹é”


### 5ã€



## åŸå­æ“ä½œå†…ç½®å‡½æ•°ï¼ˆ`__atomic`ç³»åˆ—ï¼‰
### 1. å†…å­˜åºï¼ˆMemory Orderï¼‰æ¨¡å‹â€‹â€‹
| **å†…å­˜åºâ€‹**â€‹          | â€‹**â€‹ä½œç”¨â€‹**â€‹                      | â€‹**â€‹é€‚ç”¨åœºæ™¯â€‹**â€‹      |
| ------------------ | ------------------------------- | ----------------- |
| `__ATOMIC_RELAXED` | æ— åŒæ­¥çº¦æŸï¼Œä»…ä¿è¯åŸå­æ€§                    | ç‹¬ç«‹è®¡æ•°å™¨ï¼ˆå¦‚ç»Ÿè®¡ï¼‰        |
| `__ATOMIC_ACQUIRE` | ç¦æ­¢åç»­æ“ä½œé‡æ’åˆ°è¯¥æ“ä½œå‰ï¼ˆ**è¯»å±éšœ**ï¼‰          | **é”è·å–**ã€å…±äº«æ•°æ®åŠ è½½åæ“ä½œ |
| `__ATOMIC_RELEASE` | ç¦æ­¢å‰é¢æ“ä½œé‡æ’åˆ°è¯¥æ“ä½œåï¼ˆå†™å±éšœï¼‰              | **é”é‡Šæ”¾**ã€å…±äº«æ•°æ®ä¿®æ”¹å‰æ“ä½œ |
| `__ATOMIC_ACQ_REL` | è¯»æ‰§è¡Œè·å–å±éšœï¼Œå†™æ‰§è¡Œé‡Šæ”¾å±éšœï¼ˆRMWæ“ä½œï¼‰          | CASæ“ä½œ             |
| `__ATOMIC_SEQ_CST` | å…¨å±€é¡ºåºä¸€è‡´æ€§ï¼ˆé»˜è®¤ï¼‰ï¼Œç­‰æ•ˆ`ACQUIRE+RELEASE` | å¼ºä¸€è‡´æ€§éœ€æ±‚ï¼ˆå¦‚æ ‡å¿—ä½åŒæ­¥ï¼‰    |
| `__ATOMIC_CONSUME` | å› å®ç°ç¼ºé™·ï¼Œå®é™…è¢«æå‡ä¸º`ACQUIRE`           | ä¸æ¨èä½¿ç”¨             |

> ğŸ’¡ å†…å­˜åºä¸Linuxå†…æ ¸å±éšœå¯¹åº”å…³ç³»
> - `__atomic_thread_fence(__ATOMIC_SEQ_CST)`â‰¡Â `smp_mb()`
> - `__atomic_load_n(ptr, ACQUIRE)`â‰¡Â `smp_load_acquire()`




### â€‹â€‹2. å¸¸ç”¨åŸå­æ“ä½œå‡½æ•°â€‹â€‹
#### â€‹åŸå­åŠ è½½
```c
type __atomic_load_n(type *ptr, int memorder);      // è¿”å›å€¼
void __atomic_load(type *ptr, type *ret, int memorder); // ç»“æœå­˜ret
```

#### åŸå­å­˜å‚¨
```c
void __atomic_store_n(type *ptr, type val, int memorder);
void __atomic_store(type *ptr, type *val, int memorder);
```

#### â€‹åŸå­äº¤æ¢
```c
type __atomic_exchange_n(type *ptr, type val, int memorder); // è¿”å›æ—§å€¼
void __atomic_exchange(type *ptr, type *val, type *ret, int memorder);
```


#### åŸå­ç®—æœ¯è¿ç®—
```c
â€‹è¿”å›æ–°å€¼â€‹â€‹ï¼š__atomic_add_fetch,Â __atomic_sub_fetch,Â __atomic_and_fetchï¼ˆæ”¯æŒ`&|^~`ä½æ“ä½œï¼‰
    
è¿”å›æ—§å€¼â€‹ï¼š__atomic_fetch_add,Â __atomic_fetch_sub,Â __atomic_fetch_or
```


#### â€‹åŸå­æ¯”è¾ƒäº¤æ¢ï¼ˆCASï¼‰
```c
bool __atomic_compare_exchange_n(type *ptr, type *expected, type desired, 
                                 bool weak, int success_mem, int failure_mem);
```

> - `weak=true`ï¼šå…è®¸è™šå‡å¤±è´¥ï¼ˆæ€§èƒ½æ›´é«˜ï¼‰
> - `failure_mem`ä¸èƒ½å¼ºäºÂ `success_mem`

#### â€‹æ ‡å¿—ä½æ“ä½œ
```c
bool __atomic_test_and_set(void *ptr, int memorder);  // è®¾ç½®å­—èŠ‚ä¸ºéé›¶å€¼
void __atomic_clear(bool *ptr, int memorder);        // åŸå­æ¸…é›¶
```

#### å†…å­˜å±éšœ
```c
void __atomic_thread_fence(int memorder);    // çº¿ç¨‹é—´åŒæ­¥
void __atomic_signal_fence(int memorder);    // çº¿ç¨‹å†…ä¸ä¿¡å·å¤„ç†å‡½æ•°åŒæ­¥
```


#### æº¢å‡ºæ£€æŸ¥å‡½æ•°ï¼ˆ`__builtin_xxx_overflow`ï¼‰
> - â€‹**â€‹å®æ—¶æ£€æµ‹â€‹**â€‹ï¼šåœ¨ç®—æœ¯è¿ç®—æ—¶æ£€æµ‹æº¢å‡ºï¼Œè¿”å›å¸ƒå°”å€¼æŒ‡ç¤ºæ˜¯å¦æº¢å‡º
> - â€‹**â€‹ç±»å‹è¦†ç›–â€‹**â€‹ï¼šæ”¯æŒæœ‰ç¬¦å·/æ— ç¬¦å·æ•´æ•°ï¼ˆ`int`/`long`/`long long`ï¼‰åŠé€šç”¨ç±»å‹

```c
// åŠ æ³•æº¢å‡ºæ£€æµ‹
bool __builtin_add_overflow(type1 a, type2 b, type3 *res); 
bool __builtin_sadd_overflow(int a, int b, int *res);  // æœ‰ç¬¦å·ç‰¹åŒ–

// å‡æ³•æº¢å‡ºæ£€æµ‹
bool __builtin_sub_overflow(type1 a, type2 b, type3 *res);
bool __builtin_ssub_overflow(int a, int b, int *res);

// ä¹˜æ³•æº¢å‡ºæ£€æµ‹
bool __builtin_mul_overflow(type1 a, type2 b, type3 *res);
bool __builtin_smul_overflow(int a, int b, int *res);
```

- 1 ç¼–è¯‘æ—¶æ£€æµ‹æ‰©å±•â€‹
```c
bool __builtin_add_overflow_p(a, b, c);  // ä¸å­˜å‚¨ç»“æœï¼Œä»…è¿”å›æ˜¯å¦æº¢å‡º

â€‹â€‹åº”ç”¨åœºæ™¯â€‹â€‹ï¼šå®å®šä¹‰ä¸­å®‰å…¨æ‰§è¡Œå¸¸é‡è¿ç®—
#define SAFE_ADD(a, b) (__builtin_add_overflow_p(a, b, (typeof(a+b))0) ? 0 : (a+b))
```




### â€‹â€‹3. è‡ªæ—‹é”å®ç°ç¤ºä¾‹â€‹â€‹ï¼ˆ`__atomic`ï¼‰
```c
#include <stdatomic.h> // å¼•å…¥åŸå­æ“ä½œæ‰€éœ€çš„å¤´æ–‡ä»¶
#include <stdio.h>     // å¼•å…¥æ ‡å‡†è¾“å…¥è¾“å‡ºåº“
#include <stdlib.h>    // å¼•å…¥åŠ¨æ€å†…å­˜åˆ†é…å‡½æ•°çš„å¤´æ–‡ä»¶
#include <threads.h>   // å¦‚æœéœ€è¦åˆ›å»ºçº¿ç¨‹ï¼Œéœ€å¼•å…¥æ­¤å¤´æ–‡ä»¶
#include <unistd.h>    // å¼•å…¥sleepå‡½æ•°çš„å¤´æ–‡ä»¶

// å®šä¹‰è‡ªæ—‹é”ç»“æ„ä½“ï¼ŒåŒ…å«ä¸€ä¸ªåŸå­å¸ƒå°”å˜é‡ä½œä¸ºé”çš„çŠ¶æ€
typedef struct {
    atomic_bool lock;  // true è¡¨ç¤ºé”å·²è¢«å ç”¨ï¼Œfalse è¡¨ç¤ºé”å¯ç”¨
} spinlock_t;

/**
 * å°è¯•è·å–é”ï¼Œå¦‚æœé”ä¸å¯ç”¨ï¼Œåˆ™ä¸æ–­å¾ªç¯ç›´åˆ°æˆåŠŸè·å–é”ä¸ºæ­¢ã€‚
 * @param s æŒ‡å‘spinlock_tç»“æ„ä½“çš„æŒ‡é’ˆ
 */
void spin_lock(spinlock_t *s) {
    // ä½¿ç”¨__atomic_exchange_nåŸå­æ“ä½œå°è¯•è®¾ç½®é”ä¸ºtrueï¼Œå¹¶ç­‰å¾…ç›´åˆ°æˆåŠŸ
    while (__atomic_exchange_n(&s->lock, true, __ATOMIC_ACQUIRE));
}

/**
 * é‡Šæ”¾é”ï¼Œå°†é”çŠ¶æ€è®¾ç½®ä¸ºfalseï¼Œè¡¨ç¤ºé”ç°åœ¨æ˜¯å¯ç”¨çš„ã€‚
 * @param s æŒ‡å‘spinlock_tç»“æ„ä½“çš„æŒ‡é’ˆ
 */
void spin_unlock(spinlock_t *s) {
    // ä½¿ç”¨__atomic_store_nåŸå­æ“ä½œå°†é”çŠ¶æ€è®¾ç½®ä¸ºfalse
    __atomic_store_n(&s->lock, false, __ATOMIC_RELEASE);
}

int main(){
    // åŠ¨æ€åˆ†é…spinlock_tç»“æ„ä½“æ‰€éœ€å†…å­˜
    spinlock_t *s = malloc(sizeof(spinlock_t)); 
    if (s == NULL) { // ç¡®ä¿å†…å­˜åˆ†é…æˆåŠŸ
        fprintf(stderr, "å†…å­˜åˆ†é…å¤±è´¥\n");
        return EXIT_FAILURE;
    }
    
    // åˆå§‹åŒ–é”ï¼Œè®¾ç½®ä¸ºæœªé”å®šçŠ¶æ€
    s->lock = false; 

    // è·å–é”
    spin_lock(s);

    // æ‰“å°æ¶ˆæ¯
    printf("hello world\n");

    // æ¨¡æ‹Ÿé•¿æ—¶é—´æ“ä½œï¼Œæ¯”å¦‚å¤„ç†æ•°æ®æˆ–ç­‰å¾…I/Oå®Œæˆ
    sleep(10); 

    // é‡Šæ”¾é”
    spin_unlock(s);

    // é‡Šæ”¾åˆ†é…ç»™é”çš„å†…å­˜
    free(s);

    return 0;
}

```
- 1 æ— æ³•åœ¨â€‹**â€‹å¤šè¿›ç¨‹ç¯å¢ƒâ€‹**â€‹ä¸­æ­£å¸¸å·¥ä½œçš„æ ¹æœ¬åŸå› åœ¨äºï¼šâ€‹**â€‹é”çŠ¶æ€å˜é‡Â `s->lock`æœªåœ¨è¿›ç¨‹é—´å…±äº«â€‹**â€‹ã€‚
> - `malloc`åˆ†é…çš„å†…å­˜å±äºâ€‹**â€‹è¿›ç¨‹ç§æœ‰å †â€‹**â€‹ï¼Œä¸åŒè¿›ç¨‹çš„Â `s->lock`æ˜¯ç‹¬ç«‹å‰¯æœ¬ï¼Œè€Œéå…±äº«å˜é‡
> - è¿›ç¨‹AåŠ é”ä¿®æ”¹çš„æ˜¯è‡ªå·±çš„Â `lock`å‰¯æœ¬ï¼Œè¿›ç¨‹Bæ— æ³•æ„ŸçŸ¥æ­¤å˜åŒ–ã€‚


### 4 ã€å®‰å…¨è®¡æ•°å™¨å®ä¾‹ï¼ˆæº¢å‡ºæ£€æµ‹ï¼‰â€‹
```c
#include <stdio.h>
#include <limits.h>

int safe_add(int a, int b) {
    int res;
    if (__builtin_add_overflow(a, b, &res)) {
        fprintf(stderr, "Addition overflow!\n");
        return 0; // æˆ–è‡ªå®šä¹‰å¤„ç†
    }
    return res;
}

int main() {
    printf("%d\n", safe_add(INT_MAX, 1));  // è§¦å‘æº¢å‡ºæ£€æµ‹
    return 0;
}

```



### 5ã€




## å…¶ä»–
### 1 ã€æŒæœ‰å½“å‰å‡½æ•°åçš„å­—ç¬¦ä¸²
> - `__func__`: C99æ ‡å‡†çš„ä¸€éƒ¨åˆ†
> - ` __FUNCTION__` ï¼šæ˜¯\_\_func\_\_çš„å¦ä¸€ä¸ªåç§°ï¼Œç”¨äºä¸æ—§ç‰ˆæœ¬çš„GCCå‘åå…¼å®¹ã€‚
> - `__PRETTY_FUNCTION__` ï¼š\_\_func\_\_çš„å¦ä¸€ä¸ªåå­—ï¼Œåœ¨C++ä¸­åŒ…å«äº†å‡½æ•°ç­¾å

```c
    printf("%s\n",__FUNCTION__);
    printf("%s\n",__PRETTY_FUNCTION__);
```
> (base) topeet@ubuntu:~/test/gcc$ ./app
`main`
`main`


### 2 ã€`__builtin_return_address`ï¼ˆè·å–è°ƒç”¨æ ˆä¸­æŒ‡å®šå±‚çº§çš„è¿”å›åœ°å€ï¼‰
- 1 **ä½œç”¨â€‹**â€‹ï¼šè¿”å›å½“å‰å‡½æ•°æˆ–å…¶è°ƒç”¨è€…çš„â€‹**â€‹è¿”å›åœ°å€â€‹**â€‹ï¼ˆå³å‡½æ•°æ‰§è¡Œå®Œæ¯•ååº”è·³è½¬çš„æŒ‡ä»¤åœ°å€ï¼‰ï¼Œå¸¸ç”¨äºè°ƒè¯•ã€æ€§èƒ½åˆ†ææˆ–å®‰å…¨ç›‘æ§åœºæ™¯ã€‚
```c
void * __builtin_return_address (unsigned int level)
```
> - â€‹**â€‹`level = 0`â€‹**â€‹ï¼šè·å–â€‹**â€‹å½“å‰å‡½æ•°â€‹**â€‹çš„è¿”å›åœ°å€ï¼ˆå³è°ƒç”¨å½“å‰å‡½æ•°çš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ï¼‰
> - â€‹**â€‹`level = 1`â€‹**â€‹ï¼šè·å–â€‹**â€‹ç›´æ¥è°ƒç”¨è€…â€‹**â€‹ï¼ˆä¸Šä¸€çº§å‡½æ•°ï¼‰çš„è¿”å›åœ°å€
> - â€‹**â€‹`level = n`â€‹**â€‹ï¼šå‘ä¸Šè¿½æº¯ç¬¬Â `n`çº§è°ƒç”¨è€…çš„è¿”å›åœ°å€ï¼ˆä¾‹å¦‚Â `level=2`è·å–ä¸Šä¸Šçº§ï¼‰


```c
    void* caller_addr = __builtin_return_address(0); // è·å–å‡½æ•°åœ°å€
    printf("Called by: %p\n", caller_addr);
```
> (base) topeet@ubuntu:~/test/gcc$ ./app
`Called by: 0x7fe7a8b3d083`






### 3 ã€

### 4 ã€





# äºŒã€é¢„å¤„ç†è¿‡ç¨‹åŠå…¶æŒ‡ä»¤

## é¢„å¤„ç†è¿‡ç¨‹
### 1 ã€å­—ç¬¦é›†è½¬æ¢â€‹
> - æºæ–‡ä»¶è¢«**è½¬æ¢ä¸ºç¼–è¯‘å™¨å†…éƒ¨å­—ç¬¦é›†ï¼ˆé€šå¸¸ä¸ºUTF-8ï¼‰**
> - éæ ‡å‡†å­—ç¬¦å¯èƒ½å¯¼è‡´æœªå®šä¹‰è¡Œä¸ºï¼ˆå¦‚æŸäº›ç¼–è¯‘å™¨å¯¹éASCIIå­—ç¬¦çš„è­¦å‘Šï¼‰

### 2 ã€åˆå§‹æ–‡æœ¬å¤„ç†â€‹
#### è¡Œç»“æŸç¬¦æ ‡å‡†åŒ–â€‹â€‹
- 1 ç»Ÿä¸€å¤„ç†`LF`/`CRLF`/`CR`ä¸º`\n`ï¼ŒGCCé»˜è®¤æ— è­¦å‘Šä½†Cæ ‡å‡†è§†ä¸ºæœªå®šä¹‰è¡Œä¸º

#### ä¸‰å­—ç¬¦åºåˆ—æ›¿æ¢â€‹â€‹ï¼ˆéœ€`-trigraphs`ç¼–è¯‘é€‰é¡¹ï¼‰

```c
??( â†’ [     ??) â†’ ]     ??< â†’ {      ??> â†’ }     ??= â†’ #
??/ â†’ \     ??' â†’ ^     ??! â†’ |      ??- â†’ ~
```
- 2 é»˜è®¤ç¦ç”¨ï¼ˆ`-Wtrigraphs`è­¦å‘Šï¼‰

#### åæ–œæ ç»­è¡Œâ€‹â€‹
- 1 ä»¥`\`ç»“å°¾çš„è¡Œä¸ä¸‹ä¸€è¡Œåˆå¹¶ï¼Œåä¸èƒ½æœ‰ç©ºæ ¼

- 2 å…¸å‹åº”ç”¨ï¼šè·¨è¡Œå®å®šä¹‰
```
#define LONG_MACRO \
   do { \
       func1(); \
       func2(); \
   } while(0)
```
#### æ³¨é‡Šæ›¿æ¢
- 1 æ‰€æœ‰æ³¨é‡Šï¼ˆ`//`å’Œ`/* */`ï¼‰è¢«æ›¿æ¢ä¸ºå•ä¸ªç©ºæ ¼

### 3ã€TokenåŒ–ä¸é¢„å¤„ç†è¯­è¨€â€‹â€‹
- 1 - **Tokenåˆ†ç±»â€‹**â€‹ï¼šæ ‡è¯†ç¬¦ã€æ•°å­—ã€å­—ç¬¦ä¸²ã€æ ‡ç‚¹ã€å…¶ä»–

- 1 **å®æ‰©å±•ä¼˜å…ˆçº§â€‹**â€‹ï¼š
```c
#define foo() bar
foo()baz  â†’ bar baz   // ä¼˜å…ˆè¯†åˆ«foo()è€Œéfoo
a+++++b   â†’ a++ + ++b // è¯æ³•åˆ†æä¼˜å…ˆåˆ†å‰²æœ€é•¿token
```

> Cçš„å…³é”®å­—å¯¹é¢„å¤„ç†å™¨æ²¡æœ‰æ„ä¹‰ï¼›å®ƒä»¬æ˜¯æ™®é€šçš„æ ‡è¯†ç¬¦ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥å®šä¹‰åç§°ä¸ºå…³é”®å­—çš„å®ã€‚å®šä¹‰äº†å¯ä»¥è¢«è§†ä¸ºé¢„å¤„ç†å…³é”®å­—çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚

### 4 ã€é¢„å¤„ç†è¯­è¨€
> tokenåŒ–åï¼Œtokensæµå¯èƒ½ä¼šè¢«ç›´æ¥ä¼ è¾“ç»™ compilerâ€™s parserã€‚ç„¶åï¼Œ**å¦‚æœåŒ…å«é¢„å¤„ç†è¯­è¨€ï¼Œåˆ™ä¼šå…ˆè¿›è¡Œè½¬æ¢**ã€‚è¿™æ˜¯å¤§å¤šæ•°äººè®¤ä¸ºçš„é¢„å¤„ç†å™¨çš„å·¥ä½œã€‚

- 1 é¢„å¤„ç†è¯­è¨€ç”±è¦æ‰§è¡Œçš„æŒ‡ä»¤å’Œè¦æ‰©å±•çš„å®ç»„æˆã€‚ï¼š
> - åŒ…å«å¤´æ–‡ä»¶ã€‚è¿™äº›æ˜¯å¯ä»¥æ›¿æ¢åˆ°ç¨‹åºä¸­çš„å£°æ˜æ–‡ä»¶ã€‚
> - å®å±•å¼€ã€‚æ‚¨å¯ä»¥å®šä¹‰å®ï¼Œå®æ˜¯Cä»£ç ä»»æ„ç‰‡æ®µçš„ç¼©å†™ã€‚é¢„å¤„ç†å™¨å°†åœ¨æ•´ä¸ªç¨‹åºä¸­ç”¨å®çš„å®šä¹‰æ›¿æ¢å®ã€‚æŸäº›å®æ˜¯è‡ªåŠ¨ä¸ºæ‚¨å®šä¹‰çš„ã€‚
> - æ¡ä»¶ç¼–è¯‘ã€‚æ‚¨å¯ä»¥æ ¹æ®å„ç§æ¡ä»¶åŒ…æ‹¬æˆ–æ’é™¤ç¨‹åºçš„å„ä¸ªéƒ¨åˆ†ã€‚
> - çº¿è·¯æ§åˆ¶ã€‚å¦‚æœä½¿ç”¨ç¨‹åºå°†æºæ–‡ä»¶ç»„åˆæˆ–é‡æ–°æ’åˆ—ä¸ºä¸­é—´æ–‡ä»¶ï¼Œç„¶åè¿›è¡Œç¼–è¯‘ï¼Œåˆ™å¯ä»¥ä½¿ç”¨è¡Œæ§åˆ¶æ¥é€šçŸ¥ç¼–è¯‘å™¨æ¯ä¸ªæºè¡Œçš„åŸå§‹æ¥æºã€‚
> - è¯Šæ–­ã€‚æ‚¨å¯ä»¥åœ¨ç¼–è¯‘æ—¶æ£€æµ‹é—®é¢˜å¹¶å‘å‡ºé”™è¯¯æˆ–è­¦å‘Šã€‚




### 5ã€


### 6ã€






## å¤´æ–‡ä»¶åŒ…å«æœºåˆ¶
### 1 ã€åŒ…å«æŒ‡ä»¤â€‹
```c
#include <file.h>  // ç³»ç»Ÿç›®å½•æœç´¢ï¼ˆ-Iæ·»åŠ è·¯å¾„ï¼‰
#include "file.h"  // å…ˆå½“å‰ç›®å½•ï¼Œå†ç³»ç»Ÿç›®å½•ï¼ˆ-iquoteæ§åˆ¶ï¼‰
```

- 1  ç¼–è¯‘æ—¶æŒ‡å®šçš„ç›®å½•ï¼ˆé€šè¿‡Â `-iquote`Â æ§åˆ¶ï¼‰ã€‚
```
gcc -iquote /project/include main.c # æ·»åŠ è‡ªå®šä¹‰å½“å‰ç›®å½•è·¯å¾„
```
> (base) topeet@ubuntu:~/test/gcc$ `gcc main.c test.c -o app `
main.c:9:10: fatal error: test.h: `æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•`
    9 | #include "test.h"
      |          ^~~~~~~~
compilation terminated.
(base) topeet@ubuntu:~/test/gcc$ `gcc main.c test.c -o app -iquote ./inc`
(base) topeet@ubuntu:~/test/gcc$ ./app
4




### 2ã€gccå¦‚ä½•å®ç°è°ƒç”¨å‡½æ•°
- 1 å¤´æ–‡ä»¶ï¼ˆ`.h`ï¼‰åªåŒ…å«å‡½æ•°çš„å£°æ˜ï¼ˆdeclarationï¼‰ï¼Œè€Œå‡½æ•°çš„å…·ä½“å®ç°ï¼ˆdefinitionï¼‰é€šå¸¸ä½äºæºæ–‡ä»¶ï¼ˆ`.c`ï¼‰æˆ–åº“æ–‡ä»¶ï¼ˆ`.a`ã€`.so`ï¼‰ä¸­

> æ ‡å‡†åº“å‡½æ•°ï¼ˆå¦‚ `printf`ã€`malloc`ï¼‰çš„å®ç°é€šå¸¸åœ¨ **GNU C Libraryï¼ˆglibcï¼‰** ä¸­ã€‚ä¾‹å¦‚ï¼š
> - `printf`Â çš„å®ç°ä½äº glibc çš„æºç ä¸­ï¼ˆå¦‚Â `stdio-common/vfprintf.c`ï¼‰ã€‚
> - ç¼–è¯‘æ—¶ï¼Œé“¾æ¥å™¨ä¼š**è‡ªåŠ¨é“¾æ¥ glibc åº“**ã€‚


> **è‡ªå·±ç¼–å†™çš„å‡½æ•°éœ€è¦è‡ªå·±é“¾æ¥ã€‚**
(base) topeet@ubuntu:~/test/gcc$ `gcc main.c test.c -o app`
(base) topeet@ubuntu:~/test/gcc$ ./app
4



### 3 ã€



### 4 ã€



## å®å®šä¹‰ä¸æ“ä½œ
### 1 ã€åŸºç¡€å®ç±»å‹â€‹
| **ç±»å‹â€‹**â€‹ | â€‹**â€‹è¯­æ³•â€‹**â€‹              | â€‹**â€‹ç¤ºä¾‹â€‹**â€‹                    | â€‹**â€‹æ³¨æ„äº‹é¡¹â€‹**â€‹       |
| -------- | ----------------------- | ----------------------------- | ------------------ |
| æ— å‚å®      | `#define IDENT text`    | `#define PI 3.14`             | æœ«å°¾æ— åˆ†å·              |
| å¸¦å‚å®      | `#define MACRO(p) text` | `#define SQUARE(x) ((x)*(x))` | å‚æ•°å…¨æ‹¬å·é¿å…ä¼˜å…ˆçº§é”™è¯¯       |
| å¯å˜å‚æ•°å®    | `#define MACRO(...)`    | `#define LOG(fmt, ...)`       | ç”¨`__VA_ARGS__`å¼•ç”¨å‚æ•° |

### 2 ã€é«˜çº§æ“ä½œç¬¦â€‹
- 1 **å­—ç¬¦ä¸²åŒ–ï¼ˆ#ï¼‰â€‹**â€‹ï¼šå°†å‚æ•°è½¬ä¸ºå­—ç¬¦ä¸²å­—é¢å€¼
```d
#define STR(s) #s      // STR(hello) â†’ "hello"
```


- 1 **ç¬¦å·è¿æ¥ï¼ˆ##ï¼‰â€‹**â€‹ï¼šæ‹¼æ¥æ ‡è¯†ç¬¦
```d
#define CONCAT(a,b) a##b // CONCAT(var,1) â†’ var1
```
- 2 `##`Â çš„æ‹¼æ¥ç»“æœÂ `hellowww`Â å¿…é¡»æ˜¯ä¸€ä¸ªå·²å­˜åœ¨çš„æ ‡è¯†ç¬¦ï¼ˆå¦‚å˜é‡ã€å‡½æ•°åç­‰ï¼‰ï¼Œå¦åˆ™ä¼šæŠ¥é”™
```c
#define STR(a,b) a##b

    char *hello="hello";


    char *c;
    c=STR(hell,o);
    printf("%s\n",c);
```
> (base) topeet@ubuntu:~/test/gcc$ ./app
`hello`



- 1 **å¤šçº§å±•å¼€â€‹**â€‹ï¼š
```d
#define xstr(s) str(s) // å¼ºåˆ¶äºŒæ¬¡å±•å¼€
#define str(s) #s
str(foo) â†’ "foo"       // ç›´æ¥å±•å¼€
xstr(foo) â†’ "4"        // fooå…ˆå±•å¼€ä¸º4ï¼Œå†å­—ç¬¦ä¸²åŒ–
```
- 2 xstr(foo) â†’ str(s) â†’ str(42) â†’ #42 â†’ "42"
> `xstr(s)`Â çš„å®ä½“æ˜¯Â `str(s)`ï¼Œä¸”Â `s`Â æ²¡æœ‰è¢«Â `#`Â æˆ–Â `##`Â æ“ä½œç¬¦å¤„ç†ã€‚å› æ­¤ï¼š
> 1. åœ¨æ›¿æ¢Â `xstr(foo)`Â æ—¶ï¼Œå‚æ•°Â `s`ï¼ˆå³Â `foo`ï¼‰**ä¼šè¢«é¢„å…ˆå±•å¼€**ä¸ºÂ `42`ã€‚
> 2. æ›¿æ¢ä¸ºÂ `str(42)`ï¼Œæ­¤æ—¶Â `str(42)`Â è¢«å±•å¼€ä¸ºÂ `#42`Â â†’Â `"42"`ã€‚


### 3 ã€é¢„å®šä¹‰å®â€‹
| **å®åâ€‹**â€‹      | â€‹**â€‹ç±»å‹â€‹**â€‹ | â€‹**â€‹å«ä¹‰â€‹**â€‹           |
| ------------- | ---------- | -------------------- |
| `__FILE__`    | å­—ç¬¦ä¸²        | **å½“å‰æºæ–‡ä»¶å**           |
| `__LINE__`    | æ•´å‹         | **å½“å‰è¡Œå·**ï¼ˆ`#line`å¯ä¿®æ”¹ï¼‰ |
| `__DATE__`    | å­—ç¬¦ä¸²        | ç¼–è¯‘æ—¥æœŸï¼ˆ"MMM DD YYYY"ï¼‰  |
| `__TIME__`    | å­—ç¬¦ä¸²        | ç¼–è¯‘æ—¶é—´ï¼ˆ"HH:MM:SS"ï¼‰     |
| `__func__`    | å­—ç¬¦ä¸²        | **å½“å‰å‡½æ•°å**ï¼ˆC99æ ‡å‡†ï¼‰     |
| `__cplusplus` | é•¿æ•´å‹        | C++ç‰ˆæœ¬æ ‡è¯†ï¼ˆå¦‚`202002L`ï¼‰  |
|               |            |                      |


### 4 ã€



##  æ¡ä»¶ç¼–è¯‘ä¸è¯Šæ–­
### 1 ã€æ¡ä»¶ç¼–è¯‘æŒ‡ä»¤â€‹
```c
#ifdef DEBUG         // æ£€æŸ¥DEBUGæ˜¯å¦å®šä¹‰
    debug_code();
#elif defined(TEST)  // å¤šåˆ†æ”¯æ¡ä»¶
    test_code();
#else
    release_code();
#endif
```

### 2 ã€ç¼–è¯‘è¯Šæ–­â€‹
- 1 **é”™è¯¯é˜»æ–­â€‹**â€‹ï¼š
```d
#if !defined(C_VERSION)
    #error "C_VERSION must be defined"
#endif
```

- 1 **è­¦å‘Šæç¤ºâ€‹**â€‹ï¼š
```d
#if __STDC_VERSION__ < 201112L
    #warning "Recommend C11 or later"
#endif
```

```c
#if __STDC_VERSION__ < 501112L
    #warning "Recommend C11 or later"
#endif
```
> (base) topeet@ubuntu:~/test/gcc$ `gcc main.c -o app`
main.c:57:6: warning:` #warning "Recommend C11 or later" [-Wcpp]`
   57 |     #warning "Recommend C11 or later"
      |      ^~~~~~~



### 3 ã€



##  ç‰¹æ®ŠæŒ‡ä»¤ä¸æœ€ä½³å®è·µ
### 1 ã€è¡Œæ§åˆ¶ä¸Pragmaâ€‹
```d
#line 42 "new_filename.c"  // ä¿®æ”¹è¡Œå·å’Œæ–‡ä»¶å
_Pragma("pack(1)")         // ç­‰ä»·äº #pragma pack(1)
```
- 2 `#gragma pack(<opt:pow(2, x>)` æŒ‡å®šåç»­ç»“æ„ä½“å†…å­˜å¯¹é½çš„å­—èŠ‚æ•°


- 2 - â€‹**â€‹`#pragma once`â€‹**â€‹ï¼šéæ ‡å‡†ä½†å¹¿æ³›æ”¯æŒçš„å¤´æ–‡ä»¶å®ˆå«æ›¿ä»£æ–¹æ¡ˆ
```c
    #line 100 "tect.c"
    _Pragma("pack(1)")

    printf("%s\n",__FILE__);
    printf("%d\n",__LINE__);

```
> (base) topeet@ubuntu:~/test/gcc$ ./app
`tect.c`
`103`


### 2 ã€å®å®šä¹‰é™·é˜±è§„é¿
|â€‹**â€‹é—®é¢˜â€‹**â€‹|â€‹**â€‹é”™è¯¯ç¤ºä¾‹â€‹**â€‹|â€‹**â€‹è§£å†³æ–¹æ¡ˆâ€‹**â€‹|
|---|---|---|
|å¤šæ¬¡æ±‚å€¼|`SQUARE(i++)`â†’Â `((i++)*(i++))`|æ”¹ç”¨å†…è”å‡½æ•°æˆ–é¿å…å‰¯ä½œç”¨å‚æ•°|
|ä¼˜å…ˆçº§é”™è¯¯|`#define MUL(a,b) a*b`â†’Â `MUL(2+3,4)=14`|å…¨æ‹¬å·åŒ…è£¹ï¼š`((a)*(b))`|
|ç±»å‹ä¸å®‰å…¨|`MAX("a", 5)`æ¯”è¾ƒæŒ‡é’ˆä¸æ•´æ•°|å‡½æ•°æ¨¡æ¿ï¼ˆC++ï¼‰æˆ–ç±»å‹æ£€æŸ¥å®|

### 3 ã€å¤´æ–‡ä»¶è®¾è®¡è§„èŒƒâ€‹
> 1. **å†…å®¹é™åˆ¶â€‹**â€‹ï¼šä»…åŒ…å«å£°æ˜ï¼ˆ**å‡½æ•°åŸå‹ã€`extern`å˜é‡ã€å®**ï¼‰ï¼Œé¿å…å®šä¹‰
> 
> 2.â€‹**â€‹è‡ªåŒ…å«åŸåˆ™â€‹**â€‹ï¼š`myheader.h`åº”ç‹¬ç«‹ç¼–è¯‘ï¼Œæ˜¾å¼åŒ…å«å…¶ä¾èµ–é¡¹
> 	
> 3.**â€‹å®ˆå«å¿…åŠ â€‹**â€‹ï¼šé˜²æ­¢é‡å¤åŒ…å«
```d
// ä¼ ç»Ÿæ–¹å¼
#ifndef UNIQUE_NAME_H
#define UNIQUE_NAME_H
/* ...å¤´æ–‡ä»¶å†…å®¹... */
#endif
```

### 4 ã€é¢„å¤„ç†çš„æ ¸å¿ƒä»·å€¼
> 1. **å¯ç§»æ¤æ€§â€‹**â€‹ï¼šé€šè¿‡æ¡ä»¶ç¼–è¯‘é€‚é…ä¸åŒå¹³å°/ç¯å¢ƒ
>     
> 2. â€‹**â€‹å¯ç»´æŠ¤æ€§â€‹**â€‹ï¼šå®å’Œå¤´æ–‡ä»¶å®ç°ä»£ç å¤ç”¨ä¸æ¨¡å—åŒ–
>     
> 3. â€‹**â€‹è°ƒè¯•çµæ´»æ€§â€‹**â€‹ï¼šæ¡ä»¶ç¼–è¯‘æ§åˆ¶è°ƒè¯•æ—¥å¿—è¾“å‡º
>     
> 4. â€‹**â€‹æ€§èƒ½ä¼˜åŒ–â€‹**â€‹ï¼šå†…è”å®æ›¿ä»£å°å‡½æ•°å‡å°‘è°ƒç”¨å¼€é”€> 




### 5ã€




## 
### 1 ã€


### 2 ã€


### 3 ã€

### 4 ã€

### 5ã€


### 6ã€


### 7ã€


### 8ã€




# ä¸‰ã€

## 
### 1 ã€


### 2 ã€


### 3 ã€

### 4 ã€

### 5ã€


### 6ã€


### 7ã€


### 8ã€



## 
### 1 ã€


### 2 ã€


### 3 ã€

### 4 ã€
### 5ã€


### 6ã€


### 7ã€


### 8ã€



## 
### 1 ã€


### 2 ã€


### 3 ã€

### 4 ã€

### 5ã€


### 6ã€


### 7ã€


### 8ã€


# å››ã€

## 
### 1 ã€


### 2 ã€


### 3 ã€

### 4 ã€

### 5ã€


### 6ã€


### 7ã€


### 8ã€



## 
### 1 ã€


### 2 ã€


### 3 ã€

### 4 ã€
### 5ã€


### 6ã€


### 7ã€


### 8ã€



## 
### 1 ã€


### 2 ã€


### 3 ã€

### 4 ã€

### 5ã€


### 6ã€


### 7ã€


### 8ã€


# äº”ã€

## 
### 1 ã€


### 2 ã€


### 3 ã€

### 4 ã€

### 5ã€


### 6ã€


### 7ã€


### 8ã€



## 
### 1 ã€


### 2 ã€


### 3 ã€

### 4 ã€
### 5ã€


### 6ã€


### 7ã€


### 8ã€



## 
### 1 ã€


### 2 ã€


### 3 ã€

### 4 ã€

### 5ã€


### 6ã€


### 7ã€


### 8ã€


