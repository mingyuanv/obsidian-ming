
# 开发环境准备

## 1.准备Linux开发环境

### 1.ubuntu22.04

### 2.sdk+文档
 
E:\sdk\ISVP-T23-1.1.2-20240204\ISVP-T23-1.1.2-20240204\software\zh

### 3.原理图PCB

E:\sdk\Ingenic-HDK-T23-V1.2-20240322\Document_cn



## 2.安装交叉编译链

### 1.安装 Toolchain
[[T23 SDK安装及使用指南.pdf#page=6&selection=95,0,98,9&color=important|T23 SDK安装及使用指南, p.6]]
如何安装 Toolchain


源码位置
E:\sdk\ISVP-T23-1.1.2-20240204\ISVP-T23-1.1.2-20240204\software\zh\Ingenic-SDK-T23-1.1.2-20240204-zh\resource\toolchain\gcc_540


### 2. 配置环境变量

[[T23 SDK安装及使用指南.pdf#page=6&selection=149,0,182,1&color=note|T23 SDK安装及使用指南, p.6]]
第三步：通过 export PATH=xxxx:$PATH 命令，将 toolchain 下的 bin 目录添加到 PATH 环境变量中或者在~/.bashrc 中加上下面一句永久改变。
export PATH=/home/ming/workspace/ISVP-T23-1.1.2-20240204/software/zh/Ingenic-SDK-T23-1.1.2-20240204-zh/resource/toolchain/gcc_540/mips-gcc540-glibc222-64bit-r3.3.0.smaller/bin:$PATH

## 3.烧录

### 1.密码

[[USBCloner烧录工具指南V2.pdf#page=35&selection=48,0,55,1&color=yellow|USBCloner烧录工具指南V2, p.35]]
防止工厂人员修改烧录配置操作。如需修改需要输入密码“！@#”，





### 2.USBCloner工具


点击“开始”及进入烧录状态。
开发板常按住boot键（sd卡槽旁）并点按一下reset键，使开发板也进入烧录模式。

	烧录完后。重启

4.1 基本操作
打开“配置”窗口，选择与设备对应的“平台”和“板级”配置。 
选择烧录镜像路径，如需修改默认策略配置，请参阅“界面介绍”章节。
点击“保存”按钮，保存配置。
点击“开始”按钮，设备进入 USB BOOT 模式后开始烧录


[[USBCloner烧录工具指南V2.pdf#page=34&selection=100,0,100,4&color=important|USBCloner烧录工具指南V2, p.34]]
烧录基本操作





## 4.开发软件

1.shh软件

2.串口终端

3.PCB看图

## 5.sdk的使用

[[T23 SDK安装及使用指南.pdf#page=8&selection=44,0,46,4&color=important|T23 SDK安装及使用指南, p.8]]

# uboot配置及交叉编译


## 一、单独编译

### 1.编译流程
> [!PDF|important] [[T23 BSP开发参考V1.1.pdf#page=12&selection=42,0,47,2&color=important|T23 BSP开发参考V1.1, p.12]]
> > 3.1 Uboot 编译
> 
> 

> [!PDF|important] [[T23 软件资源编译指南.pdf#page=7&selection=197,0,201,2&color=important|T23 软件资源编译指南, p.7]]
> 1.2 Uboot 编译


T23 u-boot 的板机配置文件位于 include/configs/isvpt23.h。

第一步: $ make distclean 清除旧配置。
第二步 : $ make isvpt23x_xxx 根据对应芯片类型编译 uboot ， 生成对应的 u-boot-with-spl.bin。
（make isvp_t23x_sfcnor）


### 2.位置
/home/ming/workspace/ISVP-T23-1.1.2-20240204/software/zh/Ingenic-SDK-T23-1.1.2-20240204-zh/opensource


## 二、修改uboot配置

> [!PDF|important] [[T23 软件资源编译指南.pdf#page=5&selection=40,0,42,2&color=important|T23 软件资源编译指南, p.5]]
> > Uboot 配置
> 
> 

### 1.修改内核启动后的内存配置
首先了解我们现在这个模组的参数：200W sensor、板载64M DDR，16M flash（这些外围器件和官网不同，卖家有更改）
T31zl支持H.264 H.265 MPEG硬编码，这个具体在sdk api用到的时候再细说，先暂时选H.264编码，方便兼容播放器。
根据君正提供的rmem计算文档，填写具体参数后：

根据生成的cmdline修改板卡uboot配置项

mem表示内核启动后的保留内存，rmem是预留给SDK的内存，总大小64M

rmem计算表格

### 2.修改uboot等待时间
 为了调试方便，先暂时停留3s有足够时间进入uboot，后续内核、驱动啥的没问题不需要进uboot的时候我们再把参数改小减少上电等待时间：


### 3.添加uboot配置密码


# kernel裁剪及交叉编译



[【君正T31开发记录】3.kernel裁剪及交叉编译\_君正t31刷机-CSDN博客](https://blog.csdn.net/qq_42425882/article/details/143661227?spm=1001.2101.3001.6650.4&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ECtr-4-143661227-blog-143644523.235%5Ev43%5Epc_blog_bottom_relevance_base3&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ECtr-4-143661227-blog-143644523.235%5Ev43%5Epc_blog_bottom_relevance_base3&utm_relevant_index=8)
随记：
前边，我们已经完成了uboot的编译及烧录，起作用就是初步初始化板载器件，包括CPU及RAM初始化，关watchdog等。主要作用是用来load操作系统，这里就是指load Linux kernel，现在，我们需要配置裁剪自己的Linux kernel到板子上跑起来。

首先了解下内核方面大致需要些什么配置：

支持后续加载的文件系统
支持硬件，即加载驱动，具体需要驱动的硬件包括：uart、flash(SPI)、sensor(mipi取图，IIC配置sensor)、USB有线网卡、mic、喇叭(GPIO)、硬编码器、SD卡
软件支持，后期调试需要的core file生成，没有无线网卡，无线相关协议族也暂时不需要加入
暂时先规划这么多，后续根据需求更改


## 一、内核编译

> [!PDF|important] [[T23 BSP开发参考V1.1.pdf#page=14&selection=265,0,269,2&color=important|T23 BSP开发参考V1.1, p.14]]
> > 3.2 Kernel 编译


> [!PDF|important] [[T23 软件资源编译指南.pdf#page=10&selection=36,3,42,5&color=important|T23 软件资源编译指南, p.10]]
> >  编译流程 kernel 可单独编译
> 
> 

### 1.编译流程

第一步：$make isvppikedefconfig 使用相对配置好的板级文件
第二步：$ make menuconfig 根据需求选择性编译
第三步：$ make uImage 编译内核文件
如果报错，执行 $ make distclean ，然后从第一步重新开始


内核镜像位置：Image arch/mips/boot/uImage

### 2.报错与解结
 [[编译 Linux 内核时，系统找不到 `gcc`（主机编译器）]]


### 3.注意
之前我们已经在flash中write了uboot，现在我们只需要在特定位置写入kernel镜像即可（可以向后多擦除一点flash，只要不破坏前边的uboot）


发现这里一直反复在拉起内核，内核又panic掉，查看打印，是缺少rootfs，这个我们后续再来制作rootfs

## 二、make menuconfig图形化配置裁剪

看csdn有教程

T23 BSP开发参考V1.1, p.15
内核默认的 config 留有一定余量，而实际产品往往需要进行内核裁减以释放更多的空间。以下是几个常用可供裁减的选项及说明



T23 软件资源编译指南, p.10
2.2 Kernel 裁剪选项及说明





### 1.软件依赖

- 根据需求定制内核，首先确定支持的文件系统：squashfs（压缩只读文件系统，用于不修改的系统分区）、jffs2（可选压缩读写文件系统，用于日志等有读写需求的分区）

- 支持ELF即Linux可执行文件，支持core dump生成

2.需要的驱动
 - 没有无线网卡，把这个关掉：

- 需要IIC总线驱动

- usb有线以太网卡和SD卡

- 不需要无线协议，关掉



# busybox工具集编译及根文件系统制作



[【君正T31开发记录】4.busybox工具集编译及根文件系统制作\_t31文件系统制作-CSDN博客](https://blog.csdn.net/qq_42425882/article/details/143688764)

随记：
前边，已经完成kernel启动，最后panic，因为VFS加载不到根文件系统，现在我们来打包一个根文件系统并将常用工具一起打包在根文件系统镜像中。
根文件系统，其实就是Linux kernel起来以后的 / 路径，里边包含/etc/ /proc/ /tmp/ /lib/等一系列文件夹及常用命令行程序如ls cd等，还有运行环境包括glibc等一系列动态库文件，还有环境初始化脚本如/etc/init.d/rcS。Linux kernel起来以后，根目录会挂载到根目录上。

这里用到busybox，只是因为busybox集合了linux常用的一系列应用程序，不需要我们一个一个找源码去交叉编译，生成的产物提供到根文件系统去打包而已。


后边还有记得拷贝官方驱动文件，配置开机挂载驱动这个，放到后边简单开机测试的时候说




## 一、官方的Squashfs 、Jffs2文件系统

squashfs 和 yaffs2 文件系统可直接烧录

同时烧俩个有段错误(Segmentation fault)，- 能登录但shell功能异常。
只烧squashfs，只能只读。
只烧Jffs2，系统启动不了。

### 1.Squashfs 文件系统（用这个）

> [!PDF|important] [[T23 文件系统制作指南.pdf#page=8&selection=37,0,40,8&color=important|T23 文件系统制作指南, p.8]]
> >  Squashfs 文件系统制作方法
> 
> 


> [!PDF|note] [[T23 文件系统制作指南.pdf#page=8&selection=100,0,113,32&color=note|T23 文件系统制作指南, p.8]]
> > 1．解压 squashfs.tar.bz2 压缩包命令：tar -jxvf root-uclibc-toolchain540.tar.bz2
> 
> 

解压 squashfs.tar.bz2 压缩包命令：tar -jxvf root-uclibc-toolchain540.tar.bz2

制作 squashfs 文件系统命令：
mksquashfs root-uclibc-toolchain540 root-uclibc-toolchain5.4.0-1.1.squashfs -comp xz
mksquashfs root-uclibc-toolchain540 root-uclibc-toolchain5.4.0-1.1.squashfs -comp xz


注意！
mksquashfs工具制作的时候，有修改记得删除之前生成的文件系统文件，实测重复生成是基于之前的生成文件附加后边的修改，如果在之前生成的文件系统修改生成，会附加一堆重复文件及文件夹，导致附加出来一堆带后缀的文件夹，导致生成自己不想要的文件系统。
### 2.Jffs2文件系统
 
> [!PDF|important] [[T23 文件系统制作指南.pdf#page=9&selection=0,3,34,8&color=important|T23 文件系统制作指南, p.9]]
> > T23 文件系统制作指南 T23 文件系统制作指南 Copyright® 2005-2022 Ingenic Semiconductor Co., Ltd. All rights reserved. 5 2.2 Jffs2 文件系统制作方法
> 
> 

mkfs.jffs2 -r ./appfs/ -o appfs.jffs2 -e 0x8000 -n -l -X zlib
mkfs.jffs2 -r ./appfs/ -o appfs.jffs2 -e 0x8000 -n -l -X zlib

命令: mkfs.jffs2 -o root-uclibc-toolchain5.4.0-1.1.jffs2 -r root-uclibc-toolchain540 -e 0x10000 -s 0x1000 -n -l -X zlib --pad=0x10000


### 3.补充

> [!PDF|important] [[T23 文件系统制作指南.pdf#page=7&selection=52,0,54,6&color=important|T23 文件系统制作指南, p.7]]
> > 1.3.2 文件系统搭建
> 
> 
> > 直接使用君正提供的基本文件系统压缩包开发，用户可以把 Busybox 生成的相关文件替换到压缩包，然后制作成文件系统就可以使用这些工具。



## 二、SDK sample 编译及使用

### 1.sample文档讲解

> [!PDF|important] [[T23 软件资源编译指南.pdf#page=15&selection=36,0,42,2&color=important|T23 软件资源编译指南, p.15]]
> > 5.1 SDK sample 编译
> 
> 

SDK Sample 是厂商提供的 **“功能演示模板”**，像乐高说明书一样，教你如何用SDK快速实现某个功能（比如人脸识别、联网控制）。

---
3个核心作用

快速验证：
5分钟跑通一个功能（如调用摄像头拍照），确认SDK是否满足需求。

2. 学习参考：
提供标准代码写法，避免自己瞎摸索（比如“如何发送HTTP请求”）。

3. 二次开发基础：
在其上修改代码，变成你的实际项目（如把人脸识别改成车牌识别）




## 三、配置编译busybox

### 1.编译busybox

与 kernel 的编译方法类似，需要先 make defconfig 再 make，之后 make install 会默认把安装文件生成”“ busybox/_install ”目录下。

> [!PDF|important] [[T23 BSP开发参考V1.1.pdf#page=15&selection=155,0,161,2&color=important|T23 BSP开发参考V1.1, p.15]]
> > 3.3 Busybox 编译
> 
> 




### 2.配置busybox（csdn）

没必要，用君正官方的基本都配好了


后期需要在根文件系统/etc/passwd添加用户密码配置，格式参考自己主机的格式。这里配置密码通配的话，还需要添加shadow文件用于存储本机密码，格式还是参考主机。


然后制作根文件系统的时候添加passwd文件设置默认密码或者空密码

在这里边去选自己需要的工具带上，不需要的裁剪掉减小根文件系统镜像大小。
现在调试阶段,暂时如下选：（总体思想：配网相关必须带上，权限设置的带上，磁盘挂载相关的必选，有动态加载卸载驱动的，驱动相关的也要带上，自己常用的指令编进去，能不在开发板上做的尽量都不要选，如果没有设置用户组管理的用户组配置的也全裁掉）
(只多不少)

make编译，make install安装


检查下目录下是否完整有自己需要的命令，若没有就make menuconfig选上重新编译，同理，发现有多的不必要的应用程序，就裁掉。



### 3.根据君正提供的配置文件配置busybox
> [!PDF|important] [[T23 文件系统制作指南.pdf#page=5&selection=50,0,52,6&color=important|T23 文件系统制作指南, p.5]]
> > 1.1 配置文件介绍
> 
> 

/home/ming/workspace/ISVP-T23-1.1.2-20240204/software/zh/Ingenic-SDK-T23-1.1.2-20240204-zh/opensource/busybox/configs

如果编译 glibc 的上面的工具可以不用配置flag。
> [!PDF|yellow] [[T23 文件系统制作指南.pdf#page=5&selection=109,0,113,4&color=yellow|T23 文件系统制作指南, p.5]]
> > 1.2.1 配置 flag
> 
> 


Lib/下面是相关的 C 库和工具库，都是从工具链下复制过来的，建议用户不要修改， 可以去对应的工具链下复制需要的库放到这里。其他的文件一般都是脚本和配置文件，可以直接延续使用之前的，用户可根据需求添加用户目录和脚本。目前的启动脚本存放在/etc/init.d/rcS。

 isvp_uclibc_defconfig 、isvp_glibc_defconfig 对文件系统下的工具支持比较完全 ， 但是整体文件大小会比较大 ； isvp_uclibc_mini_defconfig 、isvp_glibc_mini_defconfig 是君正根据上面完全的配置文件裁剪出比较常用的命令。


> [!PDF|note] [[T23 文件系统制作指南.pdf#page=6&selection=52,0,56,4&color=note|T23 文件系统制作指南, p.6]]
> > (1) uclibc 工具编译
> 
> 


## 四、最终方案


> [!PDF|important] [[T23 BSP开发参考V1.1.pdf#page=18&selection=180,0,186,4&color=important|T23 BSP开发参考V1.1, p.18]]
> > 4.4 Demo rootfs 简单说明
> 
> 
1.使用君正提供的基本文件系统(squashfs)+appfs文件夹(jffs2)

使用官方的Squashfs 文件系统，把busybox编译得到的bin、sbin、usr下文件拷呗补充过来



文件系统搭建直接使用君正提供的基本文件系统压缩包开发，用户可以把 Busybox 生成的相关文件替换到压缩包，然后制作成文件系统就可以使用这些工具。

注意  /lib 库下的内容，用户可以根据需求去添加，建议不要随意减少，以免导致应用程序不能运行。  建议替换之前先删除里面同名的文件，以避免制作的文件系统存在工具冲突
> [!PDF|note] [[T23 文件系统制作指南.pdf#page=7&selection=53,1,54,6&color=note|T23 文件系统制作指南, p.7]]
> > 文件系统搭建
> 
> 

推荐的系统搭建的方案是----系统 rootfs 以及不需要经常修改的系统分区采用 squashfs 文件系统，而配置分区 system 等需要经常读写的分区采用 jffs2 文件系统在system目录中

位置
/home/ming/workspace/ISVP-T23-1.1.2-20240204/software/zh/Ingenic-SDK-T23-1.1.2-20240204-zh/resource/rootfs_540/root-uclibc-toolchain540


2.appfs(=/system目录)的使用

mkfs.jffs2 -r ./appfs/ -o appfs.jffs2 -e 0x8000 -n -l -X zlib
mkfs.jffs2 -r ./appfs/ -o appfs.jffs2 -e 0x8000 -n -l -X zlib



## 五、做根文件系统（csdn/官方有配好的）（无用）

1.包装一个根文件系统
“图片库”页上的图片  (Web 视图)


3.扩展
init需要做的(/etc/inittab)：

主机名设置(/etc/hostname):

挂载点设置(/etc/fstab)：


## 六、实践

### 1.把 Busybox 生成的相关文件替换到基本文件系统(squashfs)

制作成文件系统就可以使用这些工具

cp -a /home/ming/workspace/ISVP-T23-1.1.2-20240204/software/zh/Ingenic-SDK-T23-1.1.2-20240204-zh/opensource/busybox/_install/bin/* ./bin/


### 2.编写脚本

/etc/init.d/rcS

appfs/init/appa_init.sh
appfs/init/start.sh



### 3.加载驱动
appfs/lib/modules/

appfs/etc/sensor/gc2053-t23.bin


### 4.应用程序
appfs/bin/


# T31驱动移植及加载、测试



> [!PDF|important] [[T23 软件资源编译指南.pdf#page=12&selection=36,0,40,6&color=important|T23 软件资源编译指南, p.12]]
> > 3.1 T23 需要加载驱动

> [!PDF|important] [[T23 BSP开发参考V1.1.pdf#page=26&selection=0,3,39,5&color=important|T23 BSP开发参考V1.1, p.26]]
> > T23 BSP T23 BSP 开发参考 V1.1 Copyright® 2021-2023 Ingenic Semiconductor Co., Ltd. All rights reserved. 23 6 系统资源使用与调试
> 
> 



## 一、 ISP驱动（tx-isp-t23.ko ）
ISP（Image Signal Process）是对sensor光学信号处理的第一步，是光学信号处理的后期处理单元。主要包括3A、坏点校正、去噪、强光抑制、背光补偿、色彩增强、色彩增强、镜头阴影校正等处理。

### 1.编译驱动
> [!PDF|note] [[T23 BSP开发参考V1.1.pdf#page=26&selection=63,0,65,2&color=note|T23 BSP开发参考V1.1, p.26]]
> > ISP 驱动
> 
> 


### 2.驱动注册时提供的参数。
 > [!PDF|note] [[T23 BSP开发参考V1.1.pdf#page=26&selection=126,0,137,2&color=note|T23 BSP开发参考V1.1, p.26]]
> >  ISP 驱动注册时提供多个 module_param 参数
> 
> 


### 3.补全内核下的驱动

拷贝驱动文件夹到`kernel/drivers`目录下


## 二、sensor驱动（sensorxxxxt23.ko）

### 1.编译驱动
在编译sensor 驱动之前kernel 和ISP
驱动必须已经编译完成。
> [!PDF|note] [[T23 BSP开发参考V1.1.pdf#page=26&selection=293,0,298,2&color=note|T23 BSP开发参考V1.1, p.26]]
> > 6.1.2 Sensor 驱动
> 
> 

### 2..驱动注册时提供的参数。
> [!PDF|note] [[T23 BSP开发参考V1.1.pdf#page=27&selection=110,0,116,5&color=note|T23 BSP开发参考V1.1, p.27]]
> > sensor 驱动注册时提供了多个 module_param 可配置参数
> 
> 

 A. reset，power_down 的配置 $ insmod sensor_xx_t23.ko reset_gpio=18 pwdn_gpio=20 其中，gpio 的值为 GPIO 编号，规则为：num = 32 * n + bit，例如：PA18 的 GPIO 编号为 18。

如果产品硬件遵循参考设计 insmod 时无需跟参数，使用默认值即可
### 3.图像效果文件
> [!PDF|note] [[T23 BSP开发参考V1.1.pdf#page=28&selection=36,0,39,2&color=note|T23 BSP开发参考V1.1, p.28]]
> > 6.1.4 图像效果文件
> 
> 

文件名为gc2053-t23.bin，/etc/sensor 目录需要有读写权限。可供参考的方法之一是将/etc/sensor 目录做成一个软链接，链接到一个 rw 的分区中，这样就可以在版本更新时单独更新 bin 文件。

需要在`/etc/sensor/`下放一个效果`.bin`文件

## 三、Sinfo 探测驱动（sinfo.ko ）

使用<span style="background:#fdbfff">同一个开发平台支持多个sensor 的情况</span>
### 1.编译驱动

> [!PDF|note] [[T23 BSP开发参考V1.1.pdf#page=27&selection=342,0,346,6&color=note|T23 BSP开发参考V1.1, p.27]]
> > 6.1.3 Sensor 探测识别驱动
> 
> 


### 2.驱动注册时提供的参数。
Two ways to get sensor info 
1. open /dev/sinfo; ioctl TOCTL_SINFO_GET
2. echo 1 >/proc/jz/sinfo/info; cat /proc/jz/sinfo/info




## 四、音频驱动（audio.ko）

### 1.编译驱动
> [!PDF|note] [[T23 BSP开发参考V1.1.pdf#page=37&selection=297,0,297,4&color=note|T23 BSP开发参考V1.1, p.37]]
> > 内核配置
> 
> 

> [!PDF|note] [[T23 BSP开发参考V1.1.pdf#page=38&selection=109,0,111,2&color=note|T23 BSP开发参考V1.1, p.38]]
> > Audio 驱动
> 
> 

### 2.驱动注册时提供的参数。
如果不需要驱动控制该引脚，配置该参数为 spk_gpio=-1。




## 五、配置驱动并加入根文件系统


## 六、sample测试

> [!PDF|important] [[T23 BSP开发参考V1.1.pdf#page=28&selection=104,0,110,2&color=important|T23 BSP开发参考V1.1, p.28]]
> > 6.1.5 Sample 的使用
> 
> 

/zh/Ingenic-SDK-T23-1.1.2-20240204-zh/sdk/samples/libimp-samples/

### 1.应用程序编译
> [!PDF|note] [[T23 BSP开发参考V1.1.pdf#page=16&selection=36,0,39,4&color=note|T23 BSP开发参考V1.1, p.16]]
> > 3.4 应用程序编译



### 2.VLC 浏览视频
> [!PDF|note] [[T23 PIKE开发板使用指南.pdf#page=7&selection=109,0,113,4&color=note|T23 PIKE开发板使用指南, p.7]]
> > 2.2 VLC 浏览视频
> 
> 

E:\sdk\ISVP-T23-1.1.2-20240204\ISVP-T23-1.1.2-20240204\software\zh\Ingenic-SDK-T23-1.1.2-20240204-zh\resource\tools_t23\bin\uclibc\carrier-server

开发板上电后 ， 系统会自动运行启动脚本 ， 脚本默认执行主进程./carrier-server --st=jxf23，其中 jxf23 为 sensor 型号。如果主进程被 kill 以后，想再次运行主进程，需要进入 /system/bin 目录， 然后执行./carrier-server --st=jxf23。运行结束会出现如下打印： Play this video stream using the URL: rtsp://193.169.4.228:8554/main Play this video stream using the URL: rtsp://193.169.4.228:8554/second



### 3.carrier-server的加载测试

用官方的脚本就可以了，注意不要在要用的程序中加中文注释。


还是把这个文件放在appfs/bin下才行


报错与解决(用双文件系统)
3.1自定义的加载驱动的脚本没有起作用，驱动没有下载进去
需要自己又重新加载Isp和sensor驱动

insmod tx-isp-t23.ko isp_clk=125000000

 insmod sensor_gc2053_t23.ko sensor_max_fps=25 data_interface=1



# wifi驱动调试记录


### 随记：

第一步：先看soc芯片厂商是否有配好驱动源码，一般都是有的。

君正官方的， WiFi驱动移植没有蓝牙低功耗功能，还是用WiFi原厂的吧


编译驱动，一定要原配的内核。之前加载驱动无报错但无法检测到新的SDIO卡，多半是这个原因。成功加载的wifi驱动的打印信息

有一些平台刚上电 sdio 不稳定就需要复位一下 sdio wifi，那么就需要增加复位扫卡的动作。
报错：加载成功，但是没有生成设备节点，没有识别到mmc1进行配置


## 一、资料

> [!PDF|important] [[ATBM WIFI4 驱动配置说明_FAQ_V4.4.pdf#page=4&selection=18,0,20,11&color=important|ATBM WIFI4 驱动配置说明_FAQ_V4.4, p.4]]
> > 1 单独编译驱动的编译方法
> 
> 

 > [!PDF|important] [[T23 BSP开发参考V1.1.pdf#page=39&selection=60,0,62,4&color=important|T23 BSP开发参考V1.1, p.39]]
> > 6.11 Wifi
> 
> 

> [!PDF|note] [[T23 BSP开发参考V1.1.pdf#page=31&selection=280,0,336,2&color=note|T23 BSP开发参考V1.1, p.31]]
> > gpio_num 即 GPIO 号。计算公式为： PA(n) = 0 * 32 + n PB(n) = 1 * 32 + n ... 例如：申请 PB(10) = 1 * 32 + 10 = 42
> 
> 


## 二、wifi驱动源码配置

### 1.调整makefile指定编译器和内核目录

在makefile前面添加platform的定义，后面添加编译器路径：
```
#def of platform 
platform ?=PLATFORM_INGENICT31        
```

```
// 重点，直接导出环境，防止出错。

KERDIR:=/home/ming/workspace/ISVP-T23-1.1.2-20240204/software/zh/Ingenic-SDK-T23-1.1.2-20240204-zh/opensource/kernel/
CROSS_COMPILE:=/home/ming/workspace/ISVP-T23-1.1.2-20240204/software/zh/Ingenic-SDK-T23-1.1.2-20240204-zh/resource/toolchain/gcc_540/mips-gcc540-glibc222-64bit-r3.3.0.smaller/bin/mips-linux-gnu-
ATBM_WIFI__EXT_CCFLAGS = -DATBM_WIFI_PLATFORM=24
```

```#Linuxx
sys?= Linux
#arch:arm or arm64 or mips(NVT98517)
arch ?= mips

#cross compile path
ifeq ($(platform),PLATFORM_INGENICT31)
KERDIR:=/home/ming/workspace/ISVP-T23-1.1.2-20240204/software/zh/Ingenic-SDK-T23-1.1.2-20240204-zh/opensource/kernel/
CROSS_COMPILE:=/home/ming/workspace/ISVP-T23-1.1.2-20240204/software/zh/Ingenic-SDK-T23-1.1.2-20240204-zh/resource/toolchain/gcc_540/mips-gcc540-glibc222-64bit-r3.3.0.smaller/bin/mips-linux-gnu-
ATBM_WIFI__EXT_CCFLAGS = -DATBM_WIFI_PLATFORM=24
arch = mips
endif
```
交叉编译器仅量用完整路经

SDIO 中断方式
### 2、menuconfig选择一些基本配置项
选择 ATBM603x-x/y && ATBM6012B-x/y 型号
wifi型号根据实际为 CONFIG_ATBM6012B_y

选择 sdio 总线
2.4G channel : 只支持 2.4G
 使用.h wifi固件
不用驱动一些扩展功能

频段选择为 CONFIG_ATBM_WITHBAND_2_4G_ONLY_HT20
打开ble功能 CONFIG_ATBM_BLE=y

修改 wifi 接口名称（没必要）

选择 ATBM6012B-y chip ：
vid = 0x007a
pid = 0x6011


图形化界面配置(.config文件)
```
#
# Automatically generated file; DO NOT EDIT.
# Atbm Wifi Driver Configuration
#
CONFIG_ATBM_MENUCONFIG=y
CONFIG_ATBM_WIRELESS=y
# CONFIG_ATBM_WEXT is not set

#
# select which atbm Wi-Fi chip type
#
# CONFIG_ATBM603x is not set
CONFIG_ATBM6012B_y=y
# CONFIG_ATBM6132 is not set
# CONFIG_ATBM_USB_BUS is not set
CONFIG_ATBM_SDIO_BUS=y
# CONFIG_ATBM_SPI_BUS is not set
# CONFIG_ATBM_USE_FIRMWARE_BIN is not set
CONFIG_ATBM_USE_FIRMWARE_H=y
CONFIG_ATBM_SUPPORT_BAN_24G=y
# CONFIG_ATBM_SUPPORT_BAN_5G_PRETEND_24 is not set

#
# Driver Extern Function Select
#

#
# Select WIFI bandwidth configuration 
#
CONFIG_ATBM_WITHBAND_2_4G_ONLY_HT20=y
CONFIG_ATBM_SUPPORT_BRIDGE=y
CONFIG_ATBM_FUNC_NOTXCONFIRM=y
# CONFIG_ATBM_FUNC_EARLYSUSPEND is not set
CONFIG_ATBM_FUNC_MONITOR=y
# CONFIG_ATBM_FUNC_MONITOR_HDR_PRISM is not set
# CONFIG_ATBM_FUNC_SKB_DEBUG is not set
# CONFIG_ATBM_FUNC_MEM_DEBUG is not set
# CONFIG_ATBM_FUNC_P2P_ENABLE is not set
# CONFIG_ATBM_FUNC_SW_ENC is not set
CONFIG_ATBM_FUNC_DEV_CTRL_API=y
CONFIG_ATBM_FUNC_MODULE_FS=y
CONFIG_ATBM_FUNC_PRIVE_IE=y
CONFIG_ATBM_FUNC_SAE_AUTHEN=y

#
# Driver debug features
#
# CONFIG_ATBM_APOLLO_DEBUGFS is not set
# CONFIG_ATBM_APOLLO_DEBUG_ON_BOOT is not set
# CONFIG_ATBM_APOLLO_BH_DEBUG is not set
# CONFIG_ATBM_APOLLO_WSM_DEBUG is not set
# CONFIG_ATBM_APOLLO_WSM_DUMPS is not set
# CONFIG_ATBM_APOLLO_WSM_DUMPS_SHORT is not set
# CONFIG_ATBM_APOLLO_TXRX_DEBUG is not set
# CONFIG_ATBM_APOLLO_TX_POLICY_DEBUG is not set
# CONFIG_ATBM_APOLLO_STA_DEBUG is not set
# CONFIG_ATBM_APOLLO_DUMP_ON_ERROR is not set
# CONFIG_CERT_FIRMWARE is not set
# CONFIG_BLUEDROID is not set
CONFIG_ATBM_SDIO_MMCx="mmc1"
# CONFIG_ATBM_APOLLO_USE_GPIO_IRQ is not set
CONFIG_ATBM_APOLLO_SUPPORT_SGI=y
CONFIG_ATBM_WIFIIF1_NAME="wlan%d"
CONFIG_NEED_P2P0_INTERFACE=y
CONFIG_ATBM_WIFIIF2_NAME="p2p%d"
CONFIG_ATBM_MODULE_PM_STAYAWK="pm_stayawake"
CONFIG_ATBM_MODULE_DRIVER_NAME="atbm_wlan"
CONFIG_ATBM_PLATFORM_DEVICE_NAME="atbm_dev_wifi"
CONFIG_ATBM_SDIO_VID=0x007a
CONFIG_ATBM_SDIO_PID=0x6011
CONFIG_ATBM_MODULE_NAME="atbm6x3x_wifi_usb"
CONFIG_MAC80211_ATBM_RC_DEFAULT=""
CONFIG_ATBM_BLE=y
CONFIG_ATBM_BLE_WIFI_PLATFORM=y
# CONFIG_ATBM_ONLY_BLE_WIFI_PLATFORM is not set

```




 > [!PDF|note] [[ATBM WIFI4 驱动配置说明_FAQ_V4.4.pdf#page=15&selection=20,0,20,8&color=note|ATBM WIFI4 驱动配置说明_FAQ_V4.4, p.15]]
> > 驱动一些扩展功能
> 
> 不用管



### 3、调整firmware文件
按照文档，需要把firmware文件夹下的头文件复制到hal_apollo下面

只支持 BLE+WIFI，不支持纯 WIFI
此时只需要放置 BLE+WIFI 共存的 firmware 即可，不支持切换到纯 WIFI 固件，是为了编译出来的减小体积。
`cp ./firmware/Asmlite/ASMLITE_SDIO_24M_svn19040_WiFiBLECombIPC.h  ./hal_apollo/firmware_sdio.h`

### 4、驱动数据结构解析
根据原理图和platform的宏定义，指定对应的power管脚
```
struct atbm_platform_data {
    const char *mmc_id;
    const int irq_gpio;
    const int power_gpio;
    const int reset_gpio;
    int (*power_ctrl)(const struct atbm_platform_data *pdata,
              bool enable);
    int (*clk_ctrl)(const struct atbm_platform_data *pdata,
              bool enable);
    int (*insert_ctrl)(const struct atbm_platform_data *pdata,
              bool enable);
};

struct atbm_platform_data platform_data = {
#ifdef SDIO_BUS
    .mmc_id       = CONFIG_ATBM_SDIO_MMC_ID,
    .clk_ctrl     = NULL,
    .power_ctrl   = atbm_power_ctrl,
    .insert_ctrl  = atbm_insert_crtl,
#if(ATBM_WIFI_PLATFORM == PLATFORM_XUNWEI)
    .irq_gpio    = EXYNOS4_GPX2(4),
    .power_gpio    = EXYNOS4_GPC1(1),
#endif
#if(ATBM_WIFI_PLATFORM == PLATFORM_AMLOGIC_S805)
    .irq_gpio    = INT_GPIO_4,
    .power_gpio    = 0,
#endif
#if(ATBM_WIFI_PLATFORM == PLATFORM_AMLOGIC_905)
    .irq_gpio    = 100,
    .power_gpio    = 0,
#endif
#if(ATBM_WIFI_PLATFORM == PLATFORM_FRIENDLY)
    .power_gpio    = EXYNOS4_GPK3(2),
#endif
#if(ATBM_WIFI_PLATFORM == PLATFORM_GK7202V330)
    .power_gpio = GK7202V330_WIFI_RESET_GPIO,
#endif
#if(ATBM_WIFI_PLATFORM == PLATFORM_INGENICT31)
    .power_gpio = 0*32+6,
#endif
    .reset_gpio = 0,
#else
    .clk_ctrl     = NULL,
    .power_ctrl   = NULL,
    .insert_ctrl  = NULL,
#endif
};
```



### 5、修改外部调用（复位&扫卡动作）
增加复位&扫卡动作，直接套用君正T31的模板即可

修改atbm_platform.c文件的atbm_platform_power_ctrl、atbm_platform_insert_crtl两个static函数
当ATBM_WIFI_PLATFORM == PLATFORM_INGENICT31的时候，申明外部函数和一个外部io定义
```
#if (ATBM_WIFI_PLATFORM == PLATFORM_INGENICT31)
extern int jzmmc_manual_detect(int index,int on);
static int WL_REG_EN = 32+26 ;
#endif
```


这些定义具体用在这些地方：
在atbm_platform_power_ctrl中，对于宏定义为t31平台时，这么处理
```
#if (ATBM_WIFI_PLATFORM == PLATFORM_INGENICT31)
    if(enabled)
    {
        atbm_printk_platform("[%s]:reset altobeam platform wifi...\n",__func__);
        gpio_request(WL_REG_EN,"sdio_wifi_power_on");

        atbm_printk_platform("[%s]:reset altobeam platform wifi to 0\n",__func__);
        gpio_direction_output(WL_REG_EN,0);
        msleep(300);

        atbm_printk_platform("[%s]:reset altobeam platform wifi to 1\n",__func__);
        gpio_direction_output(WL_REG_EN,1);
        msleep(100);
    }

#endif
```

在atbm_platform_insert_crtl中，对于宏定义为t31平台时，这么处理
```
#if (ATBM_WIFI_PLATFORM == PLATFORM_INGENICT31)
    mdelay(100);
    jzmmc_manual_detect(1,enabled);
    atbm_printk_platform("=========platform insert ctrl = %d====================\n",enabled);

#endif
```

### 6.其他：

wifi驱动调试记录#报错：加载成功，但是没有生成设备节点，没有识别到mmc1进行配置

halapollo/apolloplat.h
/home/ming/workspace/ATBM_LINUX_WIFI4_BLE_SVN3407_AsmLite19040_ARESM18826_Meru19963_V1.1_20241023/hal_apollo/apollo_plat.h
```
#ifndef  ATBM_WIFI_PLATFORM
#define ATBM_WIFI_PLATFORM			PLATFORM_INGENICT31
#endif

```
hal_apollo/Makefile
/home/ming/workspace/ATBM_LINUX_WIFI4_BLE_SVN3407_AsmLite19040_ARESM18826_Meru19963_V1.1_20241023/hal_apollo/Makefile
```
ifeq ($(SDIO_BUS),y)
ccflags-y += -DATBM_WIFI_PLATFORM=24
ccflags-y += -DATBM_SDIO_PATCH
ccflags-y += -DCONFIG_TX_NO_CONFIRM
endif

```


## 二、内核配置
调整君正sdk内核配置

> [!PDF|note] [[T23 BSP开发参考V1.1.pdf#page=39&selection=163,1,168,2&color=note|T23 BSP开发参考V1.1, p.39]]
> > .11.1 Wifi 内核配置
> 
> 

内核的make menuconfig

唐工的内核图形化配置（直接用）
D:\obsidian\ming\ming\君正T23芯片开发\sdk资料库\wifi开发资料库\.config

根据原理图，调整如下文件的io定义
/home/ming/workspace/ISVP-T23-1.1.2-20240204/software/zh/Ingenic-SDK-T23-1.1.2-20240204-zh/opensource/kernel/arch/mips/xburst/soc-t23/chip-t23/isvp/common/mmc.c
原来是这么写的
```
#ifdef CONFIGJZMMCV12MMC1
#ifdef CONFIGBCMPMCORE
extern int bcmwlan_init(void);
#endif
 struct jzmmc_platform_data sdio_pdata = {
     .removal              = MANUAL,
     .sdio_clk            = 1,
     .ocr_avail            = MMC_VDD_29_30 | MMC_VDD_30_31,
     .capacity              = MMC_CAP_4_BIT_DATA | MMC_CAP_SDIO_IRQ,
     .max_freq                       = CONFIG_MMC1_MAX_FREQ,
     .recovery_info            = NULL,
     .gpio                = NULL,  <--这里调整，指向新增的结构体&wifi_gpio
 #ifdef CONFIG_MMC1_PIO_MODE
     .pio_mode            = 1,
 #else
     .pio_mode            = 0,
 #endif
#ifdef CONFIG_BCM_PM_CORE
     .private_init            = bcm_wlan_init,
#else
     .private_init            = NULL,
#endif
 };
 #endif

具体定义如下
static struct card_gpio wifi_gpio = {
    .wp            = {GPIO_WLAN_WP,    GPIO_MMC_WIFI_RST_N_LEVEL},
    .cd            = {GPIO_WLAN_CD,    GPIO_MMC_WIFI_RST_N_LEVEL},
    .pwr        = {WLAN_PWR_EN,    GPIO_MMC_WIFI_POWER_LEVEL},
    .rst        = {WL_REG_EN,    GPIO_MMC_WIFI_RST_N_LEVEL},
};

```

根据原理图，调整对应io定义的头文件：
wlregen这些管脚的定义需要在board.h里面维护，他的路径在
/home/ming/workspace/ISVP-T23-1.1.2-20240204/software/zh/Ingenic-SDK-T23-1.1.2-20240204-zh/opensource/kernel/arch/mips/xburst/soc-t23/chip-t23/isvp/Pike/board.h
根据原理图的实际定义修改了这些地方

#define WL_WAKE_HOST 焕醒引脚
#define WL_REG_EN     复位
#define WLAN_PWR_EN   电源始能

```
/* ****************************GPIO WIFI START******************************* */
#define WL_WAKE_HOST    GPIO_PB(28)//GPIO_PC(8) i change
#define WL_REG_EN    GPIO_PB(26)//GPIO_PC(9)
#define WL_MMC_NUM    1 //sdio use MMC1

#define WLAN_PWR_EN    GPIO_PA(6)//(-1) i change
#define BCM_PWR_EN    (-1)
#define PWM_32K_OUTPUT 1//1:enable 32k output -1:disable 32k

#define GPIO_MMC_WIFI_POWER_LEVEL        HIGH_ENABLE
#define GPIO_MMC_WIFI_RST_N_LEVEL       LOW_ENABLE
#define GPIO_WLAN_WP -1
#define GPIO_WLAN_CD -1
/* ****************************GPIO WIFI END********************************* */
```

## 三、编译装载ko

### 方法一：直接编译
```
make;
make strip;
```


### 方法二：带参数编译
```
make platform=PLATFORM_INGENICT31 KERDIR=/home/ming/workspace/ISVP-T23-1.1.2-20240204/software/zh/Ingenic-SDK-T23-1.1.2-20240204-zh/opensource/kernel/ CROSS_COMPILE=/home/ming/workspace/ISVP-T23-1.1.2-20240204/software/zh/Ingenic-SDK-T23-1.1.2-20240204-zh/resource/toolchain/gcc_540/mips-gcc540-glibc222-64bit-r3.3.0.smaller/bin/mips-linux-gnu- sys=Linux arch=mips 

make platform=PLATFORM_INGENICT31 KERDIR=/home/ming/workspace/ISVP-T23-1.1.2-20240204/software/zh/Ingenic-SDK-T23-1.1.2-20240204-zh/opensource/kernel/ CROSS_COMPILE=/home/ming/workspace/ISVP-T23-1.1.2-20240204/software/zh/Ingenic-SDK-T23-1.1.2-20240204-zh/resource/toolchain/gcc_540/mips-gcc540-glibc222-64bit-r3.3.0.smaller/bin/mips-linux-gnu- sys=Linux arch=mips strip

```


加载驱动

```
insmod atbm6x3x_wifi_usb.ko wifi_bt_comb=1
```


```
[root@Ingenic-uc1_1:modules]# ifconfig -a
lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)

p2p0      Link encap:Ethernet  HWaddr 9A:A8:29:52:A2:4D  
          BROADCAST MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)

wlan0     Link encap:Ethernet  HWaddr 98:A8:29:52:A2:4D  
          BROADCAST MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)

[root@Ingenic-uc1_1:modules]# ifconfig wlan0 up
[  149.504873] [atbm_log]:atbm_setup_mac:addr(98a82952a24d)
[  149.510777] [atbm_log]:3 !!! atbm_vif_setup_params: enabling priv
[  149.543358] [atbm_log]:[STA] Interface ID:0 of type:2 added
[  149.549484] [atbm_log]:atbm_set_uapsd_param:uapsdFlags(0)
[  149.556195] [atbm_log]:br0_netdev_open()-1201: dev_get_by_name(br0)
[  149.563369] [atbm_log]:atbm_set_uapsd_param:uapsdFlags(0)
[  149.569974] [atbm_log]:atbm_set_uapsd_param:uapsdFlags(0)
[  149.576668] [atbm_log]:atbm_set_uapsd_param:uapsdFlags(0)
[  149.583257] [atbm_log]:atbm_set_uapsd_param:uapsdFlags(0)
[root@Ingenic-uc1_1:modules]# ifconfig 
lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)

wlan0     Link encap:Ethernet  HWaddr 98:A8:29:52:A2:4D  
          UP BROADCAST MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)

[root@Ingenic-uc1_1:modules]# 

```


## 四、wifi配网

用wpacli和wpasupplicant配置Liunx开发板的wlan0无线网

D:\obsidian\ming\ming\君正T23芯片开发\sdk_资料库\wifi开发资料库\wpa_cli
D:\obsidian\ming\ming\君正T23芯片开发\sdk_资料库\wifi开发资料库\wpa_supplicant
法一(不行)：
[使用wpa\_cli和wpa\_supplicant配置Liunx开发板的wlan0无线网-CSDN博客](https://blog.csdn.net/u013171226/article/details/147210210)
add_network
set_network 0 ssid "gznscy"       #这是无线网的名字
set_network 0 psk "maileizhi716"    #这是无线网的密码
set_network 0 key_mgmt NONE
enable_network 0

法二：用脚本

`ifconfig wlan0 up`
`/system/scripts/connect_ap.sh gznscy  maileizhi716`


